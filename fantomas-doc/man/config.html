<!doctype html public "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta http-equiv="Expires" content="<Mon, 01 Jan 1990 00:00:01 GMT">
<link rel="stylesheet" type="text/css" href="css1.css">
<title> Fantomas Iptconf :: Документация :: Настройка и администрирование Fantomas</title>
</head>
<body>
<br><br><br>

<table class=table1 width="95%"><tr><td class=td3 width="100%">
<font class=top1>
<a name="top" class=nolnk>4. Настройка и администрирование Fantomas</a></font><br><br>
<br>
<noindex>
<table class=table1 width="70%">
<tr><td class=td1 align=middle> 4.1 </td><td class=td2>&nbsp&nbsp&nbsp <a href="config.html#firstconfig">Настройка параметров</a>   </td></tr>
<tr><td class=td1 align=middle> 4.2 </td><td class=td2>&nbsp&nbsp&nbsp <a href="config.html#iproute2">Настройка загрузки конфигурации iproute2, скрипт "tabloid" </a>   </td></tr>
<tr><td class=td1 align=middle> 4.3 </td><td class=td2>&nbsp&nbsp&nbsp <a href="config.html#networks">Список подсетей </a>   </td></tr>
<tr><td class=td1 align=middle> 4.4 </td><td class=td2>&nbsp&nbsp&nbsp <a href="config.html#providers">Список сетевых подключений </a>   </td></tr>
<tr><td class=td1 align=middle> 4.5 </td><td class=td2>&nbsp&nbsp&nbsp <a href="config.html#zzz">"Inits" - cписок произвольных правил Iptables </a>   </td></tr>
<tr><td class=td1 align=middle> 4.6 </td><td class=td2>&nbsp&nbsp&nbsp <a href="config.html#policies">Политики</a>   </td></tr>
<tr><td class=td1 align=middle> 4.7 </td><td class=td2>&nbsp&nbsp&nbsp <a href="config.html#ipsetlist">Управление сет-листами - списки Ipset, файл "ipsetlist"</a>   </td></tr>
<tr><td class=td1 align=middle> 4.8 </td><td class=td2>&nbsp&nbsp&nbsp <a href="config.html#users">Управление группами и клиентами</a> </td></tr>
<tr><td class=td1 align=middle> 4.9 </td><td class=td2>&nbsp&nbsp&nbsp <a href="config.html#modes">Глобальные процедуры: конфигурирование системы и обработка счетчиков </a>   </td></tr>
<tr><td class=td1 align=middle> 4.10 </td><td class=td2>&nbsp&nbsp&nbsp <a href="config.html#iptconf">Консольная утилита iptconf.php</a>   </td></tr>
<tr><td class=td1 align=middle> 4.11 </td><td class=td2>&nbsp&nbsp&nbsp <a href="config.html#shaper">Ограничение скорости трафика клиентов, скрипт ifbtool</a>   </td></tr>
</table>
</noindex>
<br>
<br><hr><br><br><br>
<h3><a name="firstconfig" class=nolnk>4.1 Настройка параметров</a></h3>
<br>
<br><p>&nbsp&nbsp&nbsp В программе есть ряд параметров, которые касаются разных моментов работы программы. Они живут в файле <b>config.php</b>. <br>
&nbsp&nbsp&nbsp Большинство из них них доступны для настройки из веб-интерфейса (Вы можете их найти в разделе "Настройки &#8594 Параметры"), а остальные, впрочем, настраиваются один раз и в дальнейшем редактировать их нежелательно. <br>
&nbsp&nbsp&nbsp Часть из параметров была получена и записана при установке, а остальные имеют значения по умолчанию.<br>
<br><li class=subpoint> Настройки, доступные из веб: </li>
<br><br>
<li> <font class=text1> $backup_dir = "/usr/local/iptconf/_backup";</font>
	<blockquote>
		Путь к каталогу, в который сохраняются резервные копии файлов счетчиков.
	</blockquote>
<li> <font class=text1> $sets_dir  = "/usr/local/iptconf/sets";</font>
	<blockquote>
		Путь к каталогу, в котором хранятся файлы листов ipset.
	</blockquote>
<li> <font class=text1> $users_dir = "/usr/local/iptconf/usr"; </font>
	<blockquote>
		Путь к каталогу, в котором хранятся файлы описаний групп клиентов (IP-адресов). <br>
	</blockquote>
<font class=text1> ### Внимание! Если Вы решите изменить значения этих путей, то соответственно, Вы должны скопировать файлы из текущих каталогов в новые, а также позаботьтесь о том чтобы у пользователя httpd было право на запись в каталоги, которые Вы укажете. </font>
<a name="allowed_ip" class=nolnk> </a><br>
<br>
<li> <font class=text1> $filter_web_access = 1;</font> <br>
<li> <font class=text1> $allowed_ip = "127.0.0.1,192.168.0.1,78.78.78.78";</font> <br>
<li> <font class=text1> $site_to_redirect = "http://bash.org.ru";</font> 
<li> <font class=text1> $index_freename = "ayadvornik";</font>
<li> <font class=text1> $index_freepass = "xtkjdtrcfvjktn";</font>
	<blockquote>
		&nbsp&nbsp&nbsp Если значение $filter_web_access установлено в 1, тогда при попытке входа на веб-интерфейс, проверяется IP-адрес входящего, и если он не совпадает ни с одним из списка $allowed_ip, вместо формы авторизации в виде фрейма грузится сайт что указан в переменной $site_to_redirect. Соответственно, при $filter_web_access=0 опция отключена.<br>
		&nbsp&nbsp&nbsp $allowed_ip может содержать один адрес или, как указано в примере, список адресов через запятую без пробелов. <br>
		<br>
		&nbsp&nbsp&nbsp Хотите историю? Однажды cложилось так, что когда я был где-то посреди Москвы с ноутбуком, мне понадобилось пипец как срочно кое что поправить через веб-интерфейс. Нашел wi-fi, вышел в интернет, зашел на свой фантомас.. Сработала защита и пришлось читать баш... <br>
		&nbsp&nbsp&nbsp Поэтому существует "служебный" режим. Попробуйте убрать свой адрес из $allowed_ip и зайти на веб-интерфейс вот так: <br>
		&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp <font class=text1> http://yourhost/fantomas/?ayadvornik=xtkjdtrcfvjktn </font><br>
		<br>
		&nbsp&nbsp Редиректа не произойдет - Вы увидите окно авторизации :)<br>
		&nbsp&nbsp Как Вы уже поняли, "волшебные слова" настраиваются в $index_freename и $index_freepass. (<font class=text1> ##Прим: в предыдущих версиях эти настройки были непосредственно в самом index.php.</font>) <br>
		&nbsp&nbsp Из веб-интерфейса доступна настройка только первых трех опций, две последние можно настроить только в консольном режиме путем редактирования файла config.php. Обязательно смените значения опций $index_freename и $index_freepass на что нибудь свое. <br>
	</blockquote>
<li> <font class=text1> $monitor_def_grp = "default";</font>
	<blockquote>
		&nbsp&nbsp Имя группы пользователей, которая будет открываться по умолчанию в мониторе трафика. <br>
	</blockquote>
<li> <font class=text1> $monitor_delay = 7;</font>
	<blockquote>
		&nbsp&nbsp Время задержки (тайм-аут) в секундах, используемое по умолчанию в трафик-мониторе и мониторе процессов.<br>
		&nbsp&nbsp Не советую ставить значение меньше чем 5 сек, т.к. к примеру, трафик-монитор показывает суммарный трафик каждого юзера по выбранной группе, а это требует некоторого времени на обработку данных. <br>
		&nbsp&nbsp Для сравнения: группа из 15 клиентов у меня формируется примерно 3 сек.
	</blockquote>
<li> <font class=text1> $report_min_procent = "0.01";</font>
	<blockquote>
		&nbsp&nbsp При формировании отчета по трафику из БД ulogd, рассчитывается процентное отношение трафика конкретного хоста назначения к общей сумме трафика. 
		Так вот, в этой переменной задается уровень "отбивки" хостов, процент которых меньше или равен этому. Они не попадут в отчет с целью не захламлять его почти нулевыми значениями (обычно их много).<br>
	</blockquote>
<li> <font class=text1> $report_whoisurl = "https://www.nic.ru/whois/?query=";</font>
	<blockquote>
		&nbsp&nbsp URL для запроса информации whois в отчетах по веб-трафику, к этой строке в конец добавляется адрес IP, по которому запрашивается информация. 
	</blockquote>
<li> <font class=text1> $_set_save_onchange = TRUE;</font>
	<blockquote>
		&nbsp&nbsp Настройка сет-панели: Если значение указано TRUE, то после любой операции редактирования сет-листов, новое содержимое сет-листа будет сохраняться на диск в соответствующий файл в каталоге, указанном в переменной $sets_dir.
	</blockquote>
<li> <font class=text1> $_set_submit_query = TRUE;</font>
	<blockquote>
		&nbsp&nbsp Настройка сет-панели: Если значение указано TRUE, то сет-панель будет запрашивать подтверждение при операциях редактирования или изменения сет-листов.
	</blockquote>
<li> <font class=text1> $_set_show_listinfo = TRUE;</font>
	<blockquote>
		&nbsp&nbsp Настройка сет-панели: Если значение указано TRUE, то в сет-панели в списке сет-листов будет показываться табличная информация о количестве элементов и биндингах.
	</blockquote>
<li> <font class=text1> $viewlogs_system = "/var/logs/messages;/var/logs/secure;/var/logs/maillog;/var/logs/cron";</font>
	<blockquote>
		&nbsp&nbsp Список лог-файлов, которые можно будет просматривать их веб на странице состояния системы.
	</blockquote>
<li> <font class=text1> $viewlogs_show_last = 100;</font>
	<blockquote>
		&nbsp&nbsp Количество строк с конца лог-файла, которые программа будет загружать для показа.
	</blockquote>
<li> <font class=text1> $viewlogs_height = 650;</font>
	<blockquote>
		&nbsp&nbsp Размер по высоте (в пикселах) окна просмотра лог-файла.
	</blockquote>
<li> <font class=text1> $viewlogs_width = 700;</font>
	<blockquote>
		&nbsp&nbsp Размер по длине (в пикселах) окна просмотра лог-файла.
	</blockquote>
<li> <font class=text1> $_crontab = "/etc/crontab";</font>
	<blockquote>
		&nbsp&nbsp Путь к файлу crontab (файл настроек демона-планировщика crond).
	</blockquote>
<li> <font class=text1> $_crond = "/usr/sbin/crond";</font>
	<blockquote>
		&nbsp&nbsp Путь к исполняемому файлу демона crond.
	</blockquote>
<li> <font class=text1> $_crontabd = "/usr/bin/crontab";</font>
	<blockquote>
		&nbsp&nbsp Путь к исполняемому файлу программы crontab.
	</blockquote>
<li> <font class=text1> $crond_logfile = "/var/log/cron";</font>
	<blockquote>
		&nbsp&nbsp Путь к лог-файлу crond.
	</blockquote>
<li> <font class=text1> $_portfilter_enable = FALSE;</font>
	<blockquote>
		&nbsp&nbsp Опция указывает состояние порт-фильтра: FALSE - порт-фильтр выключен, TRUE - включен.
	</blockquote>
<li> <font class=text1> $mysql_brief_dbinfo = FALSE;</font>
	<blockquote>
		&nbsp&nbsp Если опция выставлена в TRUE, то в веб-интерфейсе в разделе "MySQL", при просмотре информации о состоянии баз, не показываются данные о таблицах входящих в БД, а только общая инфо о БД.
	</blockquote>
<li> <font class=text1> $_logs_enable = TRUE;</font>
	<blockquote>
		&nbsp&nbsp Опция указывает состояние подсистемы ведения логов Fantomas: FALSE - логи не ведутся, TRUE - логи ведутся.
	</blockquote>
<li> <font class=text1> $_logs_dir = "/usr/local/iptconf/logs";</font>
	<blockquote>
		&nbsp&nbsp Путь к каталогу с лог-файлами.
	</blockquote>
<li> <font class=text1> $_logs_level = 2;</font>
	<blockquote>
		&nbsp&nbsp Порог уровня событий, записываемых в лог, значения могут быть от 1 (наиболее полный лог) до 5 (только самые критические и системные ошибки).
	</blockquote>
<li> <font class=text1> $_logs_logged_checkpass_nolog = TRUE;</font>
	<blockquote>
		&nbsp&nbsp Указывает записывать ли в лог события о проверке пароля успешно авторизовавшегося в программе клиента во время его переходов из раздела в раздел (данные авторизации клиента перепроверяются при каждом новом запуске любого из разделов).
	</blockquote>
<li> <font class=text1> $syslogs = "fantomas.log";</font>
	<blockquote>
		&nbsp&nbsp Имя текущего файла лога программы.
	</blockquote>
<li> <font class=text1> $_logs_log_maxsize = "5M";</font>
	<blockquote>
		&nbsp&nbsp Максимально допустиммый размер файла лога, "М" - означает мегабайты ("k"-килобайты, "G"-гигабайты), при достижении файлом указанного размера, в имя файла добавляется метка текущего времени и создается новый файл с именем как указано в переменной $syslog.
	</blockquote>

</p>
<br><li class=subpoint> Недоступные из веб настройки: </li>
<p>
<li> <font class=text1> $cli_brief_mode = TRUE;</font>
	<blockquote>
		&nbsp&nbsp Режим вывода информации для консольной утилиты iptconf.php: TRUE - информация выводится в сокращенном виде, FALSE - отображение полной информации.
	</blockquote>
<li> <font class=text1> $quota_chk_arg = "50k";</font>
	<blockquote>
		&nbsp&nbsp Погрешность рассчета счетчиков при применении квот. При проверке достижения пользователем квоты, значение квоты уменьшается на это значение. <br>
		&nbsp&nbsp Это нужно когда, например, бывает что значение счетчика байт приближается максимально близко к значению квоты, так, что может даже сработать блокировка квоты, а в веб-интерфейсе клиент виден все равно активным. 
		&nbsp&nbsp "k" - означает килобайты, при считывании переменной программа конвертирует в байты автоматически.
	</blockquote>
<li> <font class=text1> $_passw_crypt_key = "somekey";</font>
	<blockquote>
		&nbsp&nbsp Ключ для шифрования данных авторизации, длина ключа должна быть 9 символов (только латинские буквы и цифры), иначе Fantomas самостоятельно дополнит на свое усмотрение или соответственно урежет длину ключа. Начиная с версии 0.1.5, если система поддерживает шифрование MD5, то Fantomas использует MD5-хеширование вместо шифрования по ключу и тогда эта опция не используется.
	</blockquote>
<li> <font class=text1> $_passw_md5_enable = TRUE;</font>
	<blockquote>
		&nbsp&nbsp Если значение TRUE, то вместо шифрования по ключу, Fantomas использует MD5-хеширование без применения ключа.
	</blockquote>
<li> <font class=text1> $keep_counts_at_polunload = TRUE;</font>
	<blockquote>
		&nbsp&nbsp Может быть TRUE или FALSE <br>
		&nbsp&nbsp Отвечает за запуск функции сохранения счетчиков при отключении или удалении политики, ранее примененной к клиенту. 
		Это нужно когда, например, с клиента удаляется политика или отключается его политика по умолчанию. Соответственно, удаляются правила из iptables и вместе с ними счетчики с текущими показаниями его трафика. Если потом политику добавить или включить обратно, то его счетчики могут быть по нулям. А в случае предварительной отработки рассматриваемой фунции, значения счетчиков считываются из файла counters, находящегося в каталоге iptconf. <br>
		&nbsp&nbsp По умолчанию включена. Имейте ввиду что эта функция отрабатывает не по одному конкретному клиенту или политике, а по всем счетчикам всех клиентов. 
		При огромном количестве клиентов может возникнуть какая-то задержка, но это оценить сложно, т.к. при моей обкатке на 60-ти клиентах этой задержки было не заметно.<br>
		&nbsp&nbsp Кстати, при добавлении или включении политики, счетчики считываются одельно по этой политике для конкретного клиента . <br>
		&nbsp&nbsp Понимаю что надо сделать функцию раздельного сохранения счетчиков, но пока не было необходимости, да и лень, поэтому эта функция возможно появится в следующей версии.
	</blockquote>
<li> <font class=text1> $mysql_host = "127.0.0.1";</font>
<li> <font class=text1> $mysql_user = "root";</font>
<li> <font class=text1> $mysql_password = "12345";</font>
	<blockquote>
		&nbsp&nbsp Параметры подключения к серверу MySQL.
	</blockquote>
<li> <font class=text1> $mysql_logfile = "/var/log/mysqld.log";</font>
	<blockquote>
		&nbsp&nbsp Путь к лог файлу MySQL. Он потребуется для того чтоб Вы смогли смотреть этот лог через веб-интерфейс.<br>
	</blockquote>
<li> <font class=text1> $mysql_fantomas_db = "fantomas";</font>
	<blockquote>
		&nbsp&nbsp Название БД, которую Fantomas использует для своих задач.
	</blockquote>
<li> <font class=text1> $ulog_dbname = "ulogd";</font>
	<blockquote>
		&nbsp&nbsp Содержит имя БД MySQL демона Ulogd.<br>
	</blockquote>
<li> <font class=text1> $ulog_dbname = "ulogd";</font>
	<blockquote>
		&nbsp&nbsp Название БД MySQL демона ulogd.
	</blockquote>
<li> <font class=text1> $ulog_logfile = "/var/log/ulogd/ulogd.log";</font>
	<blockquote>
		&nbsp&nbsp Путь к лог файлу демона Ulogd. Он потребуется для того чтоб Вы смогли смотреть этот лог через веб-интерфейс.<br>
</blockquote>
<li> <font class=text1> $syspage_show_procs = "ulogd,mysqld,named,httpd,sshd";</font>
	<blockquote>
		&nbsp&nbsp Устаревшая переменная, в ранних версиях программы отсюда брался список процессов, информация о статусе которых отображалась на странице состояния системы. В последствии инфа о процессах стала не нужна, т.к. появился монитор процессов, а ее бывшее место заняла панель просмотра системных логов. Оставлена для обратной совместимости.
	</blockquote>
<li> <font class=text1> $index_login_timeout = 0;</font>
	<blockquote>
		&nbsp&nbsp Настройка index.php: Тайм-аут в минутах, по истечению которого веб-интерфейс будет "забывать" логин и пароль текущей сессии и прийдется перелогиниться. Если указан 0, то таймаута нет, но параметры сессии будут забыты при выходе из веб-интерфейса.
	</blockquote>
<li> <font class=text1> $usr_cname_spaces = TRUE;</font>
	<blockquote>
		&nbsp&nbsp Настройка отображения групп клиентов в веб: указавает подменять ли знаки подчеркивания "_" на пробелы для тегов "cname" при отображении имен клиентов в веб-интерфейсе.
	</blockquote>

</p>
<noindex><a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./../index.html">Содержание</a></noindex><br>
<br>
<br>
<br>
<h3><a name="iproute2" class=nolnk>4.2 Настройка загрузки конфигурации iproute2, скрипт "tabloid"</a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp Fantomas имеет возможность при старте своего init-скрипта iptcldr загружать список маршрутов Iproute2. Эта опция включается в разделе "Система -> Iproute2", там доступно включение/выключение самой опции, также там можно указать сам файл конфига cо списком маршрутов, и еще там есть панель таблиц маршрутизации в которой можно добавлять/удалять таблицы и просматривать загруженные маршруты по таблицам.<br>
<br>
&nbsp&nbsp&nbsp Файл списка маршрутов называется iproute2-init и хранится в каталоге программы. Немного о самом файле: структура файла разбита на секции, каждая из которых должна принадлежать отдельной таблице маршрутизации и в этой секции должны располагаться правила этой таблицы, последняя же из секций должна содержать правила iproute2 (ip rule list). <br>
<br>
&nbsp&nbsp&nbsp Обычная секция таблицы маршрутизации выглядит так:<br>
<blockquote class=text1>
	### table &lttablename&gt zone <br>
	ip route add ... table &lttablename&gt <br>
	ip route add ... table &lttablename&gt <br>
	######### end zone 
</blockquote>
&nbsp&nbsp&nbsp Обратите внимание на количество знаков "#" и написание "table >name< zone" - писать нужно именно так! Это связано с тем что именно по этим строчкам программа распознает где начинается и где заканчивается секции таблиц.<br>
&nbsp&nbsp&nbsp Соответственно, сколько таблиц маршрутизации, столько и секций в файле должно быть.<br>
<br>
&nbsp&nbsp&nbsp После описания таблиц маршрутизации в файле идет секция описания правил маршрутизации:<br>
<blockquote class=text1>
	### rules zone <br>
	ip rule add ... table &lttablename&gt <br>
	ip rule add ... table &lttablename&gt <br>
	######### end zone 
</blockquote>
&nbsp&nbsp&nbsp Эта зона предназначена для размещения команд описания правил маршрутизации, которые являются общими для всех таблиц.<br>
<br>
&nbsp&nbsp&nbsp Из веб-интерфейса файл не редактируется, т.к. имхо обычно такой файл вообще настраивается один раз и забывается, поэтому для редактирования файла iproute2-init пользуйтесь консолью.<br>
<br> 
&nbsp&nbsp&nbsp Для чего сделано такое разделение команд по секциям? Сделано это не просто так - в консоли есть специальная утилита для работы файлом iproute2-init - tabloid. Это скрипт располагается в каталоге iptconf/tools и позволяет обрабатывать отдельно каждую из секций файла iproute2-init, его синтаксис предельно прост: <br>
<blockquote class=text1>
	tabloid {up|down|reload} [target=&lttablename&gt] 
</blockquote>
&nbsp&nbsp&nbsp Если не указан параметр "target", то обрабатываются все секции файла, в противном случае обрабатываются команды только конкретной секции. <br>
<br>
&nbsp&nbsp&nbsp Собственно, инит-скрипт iptcldr при загрузке выполняет именно этот скрипт в виде "tabloid up". <br>
<br>
</p>
<noindex><a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./../index.html">Содержание</a></noindex><br>
<br>
<br>
<br>
<h3><a name="networks" class=nolnk>4.3 Список подсетей </a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp Для любой маршрутизации нужно знать источник и адресата, не так ли? Более того, для вменяемой маршрутизации нужно видеть разницу между объектами в локальной сети и всеми остальными. Для этого при настройке установщик создал список подсетей, подключенных непосредственно к маршрутизатору, их можно настроить в веб или в консоли в файле "Networks". Веб-настройка выглядит примерно так:<br>
<img src="./networks.gif" title="панель подсетей"><br>
<br>
&nbsp&nbsp&nbsp На основе данных о подсетях также формируется ipset-лист locals, который и используется для четкой идентификации локальных подсетей и их отличия от внешних. <br>
&nbsp&nbsp&nbsp Файл "networks" располагается в каталоге где установлен Fantomas, при желании работать в консоли его можно править вручную. Синтаксис файла следующий: <br>
	<blockquote class=text3>
		&ltsubnet_address&gt [local] [notallforward] <br>
	</blockquote>
&nbsp&nbsp Здесь: <br>
<br>
&nbsp&nbsp <font class=text33>&ltsubnet_address&gt</font> - адрес подсети ( например, 192.168.0.0/24 ) <br>
<br>
&nbsp&nbsp <font class=text33>local</font> - <i>Признак того что подсеть является локальной, а значит попадает в лист locals и будет использована как локальный dst или src при генерации правил iptables. </i><br>
<br>
&nbsp&nbsp <font class=text33>notallforward</font> - <i>Если указан, то для этой подсети в цепочке FORWARD не создается правило, разрешающее маршрутизацию в нее трафика из остальных подсетей, по типу "-A FORWARD -s $other_subnet -d $this_subnet -j ACCEPT". Политика FORWARD по умолчанию ставится в DROP, поэтому сервер будет маршрутизировать в эту подсеть трафик только тех клиентов, для которых Вы вручную впишите разрешающее правило в файле <b>inits</b> (см. пункт 4.4). <br>
&nbsp&nbsp Опция полезна для фильтрации доступа между подсетями. К примеру, если у Вас несколько локальных подсетей, одна из которых имеет особый режимный статус и маршрутизировать туда трафик можно только с определенных IP-адресов. </i><br>
<br>
&nbsp&nbsp&nbsp&nbsp пример файла:
<blockquote class=text1>
	127.0.0.1 <br>
	192.168.0.0/24 local <br>
	10.120.6.0/24 local notallforward <br>
</blockquote>
<br>
&nbsp&nbsp В этом примере у нас как и в примере выше, одна из подсетей обычная локальная, а вторая - локальная "режимная". При этом, в inits, если пропускаем весь трафик, разрешающие правила могут выглядеть так: <br>
<blockquote class=text1>
	-A FORWARD -s 192.168.0.10 -d 10.120.6.0/24 -j ACCEPT
</blockquote>
<br>
&nbsp&nbsp Или можно проявить немного фантазии: <br>
<blockquote class=text1>
	-A FORWARD -s 192.168.0.10 -d 10.120.6.0/24 -p tcp -m multiport ! --ports 25,3389,8080,3128 -j ACCEPT <br>
	-A FORWARD -s 192.168.0.10 -d 10.120.6.0/24 -p udp --dport 53 -j ACCEPT <br>
	-A FORWARD -s 192.168.0.103 -d 10.120.6.0/24 -p tcp --sport 80 -j DROP
</blockquote>
<br>
&nbsp&nbsp По умолчанию, в networks попадают только локальные подсети, по которым ведется подчет и ограничение трафика, провайдерских подсетей здесь может и не быть, поскольку по ним обычно не выполняется маршрутизация "сеть-в-сеть". Хотя, у меня были мысли реализовать поддержку openvpn чтоб рулить и удаленными подсетями, а возможно и непосредственно маршрутизацией с iproute2. 
Поэтому не удивляйтесь тому что, казалось бы, присутствие параметра local здесь кажется бессмысленным. Может и дойдут руки.. 
</p>
<noindex><a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./../index.html">Содержание</a></noindex><br>
<br>
<br>
<br>
<h3><a name="providers" class=nolnk>4.4 Список сетевых подключений </a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp Здесь все предельно просто - список содержит описания сетевых интерфейсов, с которыми работает программа. <br>
&nbsp&nbsp&nbsp Аналогично списку подсетей, работать с со списком подключений можно как через веб-панель, так и в консоли. Данные списка хранятся в файле "providers". <br>
&nbsp&nbsp&nbsp Синтаксис файла: <br>
<blockquote class=text3>
	link &ltlink_name&gt [local] { <br>
	ipaddr=&ltiface_ipaddr&gt <br>
	ifname=&ltiface_name&gt <br>
	}
</blockquote>
&nbsp&nbsp Здесь: <br>
<br>
&nbsp&nbsp <font class=text33>&ltlink_name&gt</font> - Любое короткое имя подключения без пробелов и спецсимволов, логически понятное для Вас и Ваших коллег (например, mylocalnet или corbina). <br>
<br>
&nbsp&nbsp <font class=text33>local</font> - То же самое что в networks - признак локального сетевого интерфейса. <br>
<br>
&nbsp&nbsp <font class=text33>&ltiface_ipaddr&gt</font> - IP-адрес сетевого интерфейса. <br>
<br>
&nbsp&nbsp <font class=text33>&ltiface_name&gt</font> - Название сетевого интерфейса в системе ( eth0, eth1 .. ethN и т.п.). <br>
<br>
&nbsp&nbsp Фигурные скобки обязательны, причем именно в том виде как показано: открывающая скобка в одной строке с названием линка, а закрывающая обязательно в отдельной новой строке. <br>
<br>
&nbsp&nbsp&nbsp&nbsp пример:
<blockquote class=text1>
	link propellernet local {<br>
	ipaddr=192.168.0.1 <br>
	ifname=eth1 <br>
	} <br>
	<br>
	link tochka-ru { <br>
	ipaddr=78.78.78.79 <br>
	ifname=eth2 <br>
	} 
</blockquote>
</p>
<noindex><a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./../index.html">Содержание</a></noindex><br>
<br>
<br>
<br>
<h3><a name="zzz" class=nolnk>4.5 "Inits" - cписок произвольных правил Iptables </a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp Как и предыдущие списки настроек, этот список возможно редактировать как из веб так и в консольном режиме. Данные хранятся в файле "inits". <br>
&nbsp&nbsp&nbsp Список предназначен для размещения написанных админом вручную команд iptables, которые при процедуре пересоздания конфигурации (RELOAD) будут выполняться перед генерацией правил по политикам клиентов. <br>
Целью его создания было иметь возможность производить вручную небольшие манипулиции с трафиком, как то например, маркировка, разрешение  или запрещение трафика.<br>
<br>
&nbsp&nbsp&nbsp Всю основную работу c трафиком Fantomas проводит в таблице <b>mangle</b> (цепочки PREROUTING, FORWARD, COUNT_IN, COUNT_OUT и PORTFILTER). <br>
Поэтому создавайте правила очень осторожно! Помните, что действие Ваших правил способно всерьез нарушить или вообще разрушить работу Fantomas. К примеру, если здесь дропать пакеты, которые могли бы принадлежать какому то клиенту, то уже никакие правила никаких политик эти пакеты не получат. <br>
Цепочки COUNT_IN и COUNT_OUT просто <b>не используйте!</b> <br>
<br>
&nbsp&nbsp&nbsp Выше уже писалось о том что, штатно inits можно применять для раздавания вручную ACCEPT'ов на форвард трафика, в том случае, когда на одной из Ваших подсетей установлена опция "notallforward": <br>
<blockquote class=text3>
	-A FORWARD -s 192.168.0.10 -d 10.120.6.0/24 -j ACCEPT
</blockquote>
<br>
&nbsp&nbsp&nbsp Второй вариант штатного использования касается как раз mangle - можно маркировать трафик циферкой 22, а потом исключать его из общего рассчета по принципу: <br>
<blockquote class=text3>
	-t mangle -A PREROUTING -s 192.168.0.10 -d 10.120.6.0/24 -p all -j MARK --set-mark 22 <br>
	-t mangle -A COUNT_IN -m mark --mark 22 -j RETURN <br>
	-t mangle -A COUNT_OUT -m mark --mark 22 -j RETURN
</blockquote>	
&nbsp&nbsp&nbsp В этом случае указанный трафик не будет подсчитываться, т.к. при рассчете будет "вылетать" из COUNT-цепочек, не успев встретить подходящее по условиям правило. 
Это бывает полезно когда, как в примере выше, Вам нужно организовать маршрутизацию между локальными подсетями "для избранных", но при этом этот трафик является локальным и подсчитываться не должен.<br>
<br>
</p>
<noindex><a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./../index.html">Содержание</a></noindex><br>
<br>
<br>
<br>
<h3><a name="policies" class=nolnk>4.6 Политики </a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp Политики хранятся в текстовом виде в файле "policies" в каталоге Fantomas. Работать со списком политик можно тоже как из веб-интерфейса, так и в консоли. <br>
<br>
&nbsp&nbsp&nbsp <b>Политика</b> - это краткое схематичное, синтаксически соответственно оформленное, описание видов сетевого трафика с указанием действий, которые должен применять маршрутизатор к этим видам трафика. <br>
<br>
&nbsp&nbsp&nbsp Мы уже говорили про основную идею политик и их назначение в разделе <noindex><a href="./about.html#wtf_how">п.1.1.3 Как это работает?</a></noindex>. <br>
<br>
&nbsp&nbsp&nbsp Политика имеет краткое название (идентификатор), которое используется во всех операциях с политикой: ее можно назначить клиенту или большому числу клиентов (или вообще всем). Можно политику назначить группе клиентов - тогда она будет использоваться как политика по-умолчанию для членов этой группы и при создании нового клиента будет применяться автоматически (потом Вы, конечно, можете ее отменить и назначить другую политику). <br>
<br>
&nbsp&nbsp&nbsp Каждому конкретному клиенту может быть назначено сколько угодно политик - их количество ограничено только аппаратными ресурсами сервера. Главное требование: виды трафика, описанные в каждой политике, не должны повторяться в других политиках, назначенных клиенту - иначе действия политик будут попросту конфликтовать. <br>
<br>
&nbsp&nbsp&nbsp В качестве клиентов возможно использовать не только ip-адреса рабочих станций, но и адреса серверов, расположенных в локальной сети. Для серверов также возможно создавать политики, описывающие используемые ими виды трафика. Например, создать политику, разрешающую исходящий SMTP для почтового сервере или политику, разрешающую DNAT из интернет на внутренний сервер терминалов. А можно создать политику, выполняющую <font class=text1>reject tcp (80,8080,3128)</font> для сервера терминалов, если не хотите чтобы пользователи пытались ходить в интернет из под терминальной сесии. <br>
<br>
&nbsp&nbsp&nbsp Еще пример: запросы к удаленным http и ftp-серверам могут быть описаны одной политикой, а к smtp-серверам - другой. При этом первая политика может направлять трафик через одного провайдера, при этом подсчитывая трафик , а вторая - через другого, и возможно без подсчета трафика. 
Или, допустим, первой политикой Вы можете описывать доступ к удаленным http-серверам c подсчетом трафика, поддержкой месячных квот и блэк-листов, а во второй политике Вы можете описать совершенно свободный доступ в интернет без ограничений. 
И далее, можете применить эти политики разным клиентам, к примеру, первую - основной массе клиентов, а вторую - начальнику и себе любимому :). <br>
<br>
&nbsp&nbsp В веб-интерфейсе работа с политиками ведется в меню "Настройки-&gtПолитики", там есть поиск по политикам, режим создания новой политики, редактирование, поиск использующих политик у пользователей и т.д.. <br>
&nbsp&nbsp В консоли создавать новые и править существующие политики можно простым редактированием файла policies.<br>
<blockquote class=text1>
	##Примечание: Будьте внимательны при редактировании политик, уже назначенных одному или нескольким клиентам - НЕЛЬЗЯ существенно видоизменять политику если она уже на ком то применена. Допускается дополнение таких политик новыми строками, но воздерживайтесь от их видоизменения.<br> 
	&nbsp&nbsp Объясню почему: При простом редактировании текста политик с ранее сгенерированными по ней правилами ничего не происходит - для вступления изменений в силу требуется запустить процедуру пересоздания конфигурации (RELOAD). Эта процедура сперва выгружает счетчики существующих правил, а потом, при формировании новых правил для Вашей политики, процедура загружает показания до этого выгруженных счетчиков... И <b>на этом моменте</b> Вас вполне объективно будут ждать грабли: чем сильнее Вы видоизменили строки политики, тем больше вероятность того что программа не сможет определить какие показания счетчиков соответствуют Вашей политике. В результате - счетчики по нулям.<br>
</blockquote>
<br>
Далее разберем синтаксис политик, он имеет следующий вид:<br>
<br>
<blockquote class=text3>
	policy &ltpolicy_name&gt { <br>
	title "любое описание политики" <br>
	[accept | reject] &ltproto&gt &ltports&gt [dst | src] [[from | to] &ltaddress&gt] [quota &ltquota&gt] <br>
	[action] [ snat|masquerade|dnat|input [&ltdestination&gt] ] <br>
	[in | out] [&ltprovider&gt] <br>
	[manglemark &ltN&gt] <br>
	[count [nolog] ] <br>
	[[blacklist | allow_only] &ltlist&gt] <br>
	} <br>
</blockquote>	
<br>
&nbsp&nbsp<font style="text-decoration:underline;font-style:italic">ВНИМАНИЕ:</font> если Вы создаете политику из веб-интерфейса, то первую строку <font class=text1>"policy &ltpolicy_name&gt {"</font> и последнюю строку <font class=text1>"}"</font> писать НЕ НУЖНО. Программа эти теги использует для идентификации политик и отделения их друг от друга, поэтому при созхранении политики начальные и конечные теги будут добавлены автоматически. <br>
<font style="text-decoration:underline;font-style:italic">Но</font> если работаете с политиками из консоли, Вы должны обязательно использовать полный синтаксис.<br>
<br>
<font style="text-decoration:underline;font-style:italic">И еще кое что:</font> обратите внимание что закрывающая скобка политики расположена на отдельной строке, а открывающая скобка - на одной строке с названием политики. Это "правильный" синтаксис, к которому программа приучалась с рождения, пожалуйста, используйте именно такое написание.<br>
<br>
&nbsp&nbsp&nbsp По порядку:<br>
&nbsp&nbsp&nbsp <li>строка 3: <font class=text1>accept | reject</font> - непосредственно описывает вид трафика и определяет главное действие над ним - accept или reject.<br>
&nbsp&nbsp&nbsp <font class=text1>&ltproto&gt</font> может быть tcp, udp, icmp или all. <br>
&nbsp&nbsp&nbsp <font class=text1>&ltports&gt</font> может быть одним цифровым портом или несколькими портами через запятую в скобках: <font class=text1>(25,1080,3128)</font>. Порт или набор портов может иметь отрицание, которое будет означать отрицание порта или ВСЕГО набора портов, причем ставится отрицание внутри скобок: <font class=text1>(!25,1080,3128)</font>.<br>
&nbsp&nbsp&nbsp <font class=text1>dst | src </font> указание направленности трафика (--sport/--dport) : если src, то трафик идет с вышеуказанных портов, а если dst - на вышеуказанные порты. По умолчанию dst. К примеру, если у нас стоит задача описать ответный трафик почтового сервера (внутри сети есть почтовый сервер, к которому из интернет создан доступ через DNAT, а у нас стоит задача описать в политике трафик, который идет ОТ почтового сервера в интернет), то в этом случае это будет <font class=text1>src from 192.168.0.10</font>, где ip-адрес это <font class=text1>&ltaddress&gt</font> <br>
&nbsp&nbsp&nbsp <font class=text1>from | to</font> если указано, то при генерации правила, в качестве соответствующего аргумента (-s если from и -d если to) используется указанный в этой опции адрес. По умолчанию если iptables принимает в правиле сурс или дестинейшн пустым, то понимает его как all (разрешено все). К примеру, если Вам нужно разрешить трафик <font class=text1>tcp (25,110,80)</font> только на mail.ru, то так и пишем: <font class=text1>accept tcp (25,110,80) to www.mail.ru</font>. Имейте ввиду (!) что при генерации правила программа вместо www.mail.ru попытается подставить IP (доменное имя в правило iptables пихать как то некорректно), доменное имя от IP она пытается отличить по наличию трех точек, что может быть корректно не всегда. Поэтому желательно использовать все таки IP.     <br>
Еще пример: Вам нужно сделать проброс порта tcp:3389 внутрь сети, но только с двух ip-адресов. Тогда политика будет выглядеть так:<br>
<blockquote class=text3>
	title "Terminal Services DNAT for 2piplz" <br>
	accept tcp 3389 from 11.11.11.11 <br>
	accept tcp 3389 from 22.22.22.22 <br>
	in myprovider <br>
	count <br>
	action dnat 192.168.0.100 <br>
</blockquote>	
Согласитесь, несложный синтаксис? :)<br>
<br>
&nbsp&nbsp&nbsp <font class=text1>quota &ltquota&gt</font> Здесь указывается квота трафика, при достижении которого этот конкретный accept работать перестанет. Может указываться просто цифрами (понимается как байты), можно указывать обозначения мегабайт и гигабайт: 750mb, 2gb и т.п.. Т.е. если в политике несколько строк accept с разным трафиком, но quote указано только на одном accept, то при достижении лимита остальные два продолжат работать.  <br>

&nbsp&nbsp&nbsp <li>строка 4: <font class=text1>action</font>  - Определяет действие, которое будет применяться ко всем строкам accept в политике. Действем может быть dnat, snat, masquerade или input. Из опций здесь можно указать только адрес destination у dnat. <br>
&nbsp&nbsp&nbsp Заметьте, у действия SNAT адрес source не указывается, в этом нет необходимости т.к. через какой внешний интерфейс уходит трафик определяет опция <font class=text1>out</font>.<br>
&nbsp&nbsp&nbsp Так жде происходит и при действии MASQUERADE. Собственно, описанные три действия имеют свои прямые корни из iptables и, надеюсь, будут понятны многим читателям. <br>                                        
&nbsp&nbsp&nbsp А вот о действии INPUT я поясню - это действие было специально добавлено для обработки трафика, идущего не транзитно через маршрутизатор, а локально к демону или процессу, работающему на сервере. В основном правила, генерируемые этим действием, выполняют accept для трафика своего демона и, если в политике указывается опция <font class=text1>count</font>, то "прогоняют" трафик через цепочки подсчета трафика. Таким образом это действие может использовать для подсчета и сбора статистики входящего и исходящего трафика для локальных приложений сервера.<br> 

&nbsp&nbsp&nbsp <li>строка 5: <font class=text1>in | out</font> - как уже было сказано, эта опция определяет через какого провайдера трафик будет уходить или наоборот, через какого он будет приходить (например для dnat).<br>

&nbsp&nbsp&nbsp <li>строка 6: <font class=text1>manglemark N</font> - Если указано, то все пакеты, соответствующие политике, будут маркироваться цифрой N в таблице mangle, а действия над ними будут осуществляться уже с приминением в правиле условия на совпадение маркировки "-m mark".  <br>

&nbsp&nbsp&nbsp <li>строка 7: <font class=text1>count [nolog]</font> - Если указано, то по всем строкам accept будет проводиться обработка счетчиков пакетов и байт в специальных таблицах COUNT_IN и COUNT_OUT. Опция <font class=text1>nolog</font> указывается в том случае, если Вы не хотите чтоб сведения о пакетах (размер, адреса источника и назначения, порт и т.п.) записывались в базу демона ulog. Имейте при этом ввиду что в этом случае Вы не сможете смотреть статистику о посещаемых сайтах по клиентам с этой политикой.<br>

&nbsp&nbsp&nbsp <li>строка 8: <font class=text1>[[blacklist | allow_only] &ltlist&gt]</font> - управляет приминением листов ipset к данной политике (ко всем accept). Соответственно, если указано blacklist, то при адреса которые совпадают с указанным листом блокируются, а если указано allow_only, то блокируется все кроме указанного листа. Строк blacklist в политике может быть несколько, если необходимо применить к политике несколько листов, но опция allow_only должна быть только одна. <br>
<br>
<br>&nbsp&nbsp&nbsp Некоторые примеры политик Вы можете найти в дистрибутиве Fantomas в файле policies. <br>
</p>
<noindex><a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./../index.html">Содержание</a></noindex><br>
<br>
<br>
<br>
<h3><a name="ipsetlist" class=nolnk>4.7 Управление сет-листами - списки Ipset, файл "ipsetlist" </a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp ...Файл "ipsetlist" представляет из себя перечисление листов ipset (по принципу один сет-одна строка), вообще используемых в Fantomas. При старте системы Fantomas ищет файлы с соответствующими именами в каталоге из переменной $sets_dir и загружает в память.<br>
Файлы листов ipset это файлы, сгенерированные самим ipset и, следовательно, в них можно использовать весь функционал ipset как Вам угодно, здесь Вас Fantomas никак не ограничивает. <br>
<br>
&nbsp&nbsp&nbsp Работать с сет-листами возможно из веб-интерфейса или из консоли. Разница заключается в способах обработки сет-листов: для обработки сет-листов в консольном режиме Вы должны будете использовать "родной" инструментарий ipset и выполнять команды ipset вручную из коммандной строки, а что касается веб-интерфейса - для обработки сет-листов есть специальная сет-панель, в которой можно в реальном времени видеть состояние используемых сет-листов (загружен/не загружен, количество элементов и т.п.), создавать, изменять или удалять сет-листы. Вид фрагмента сет-панели:<br>
<img src="./setlist.gif" title="Сет-панель: список сетлистов">
<br>
&nbsp&nbsp&nbsp А это панель для работы с выбранным сетлистом:<br>
<img src="./set4.gif" title="Сет-панель: панель работы с сетлистом"><br>
<br>
&nbsp&nbsp&nbsp Также в веб-интерфейсе есть редактор сет-листов, в котором можно вручную редактировать сохраненные сет-листы как файлы на диске, но чтобы изменения вступили в силу, Вы должны будете выполнить RELOAD. <br>
<br>
В консоли, с помощью команд Ipset Вы можете создавать сетлисты, редактировать, связывать их, и сохранять в каталоге $sets_dir. После этого Вы должны добавить имена Ваших новых сетов в файл ipsetlist, иначе при перезагрузке или процедуре RELOAD они не будут загружены.<br>
<br>
Подробно на использовании ipset останавливаться не будем, т.к. для него существует его родная документация, с которой я Вам рекомендую ознакомиться. Ее можно найти <noindex><a href="http://ipset.netfilter.org/ipset.man.html">в интернет</a></noindex> или с консоли просто сделать man ipset. <br>
</p>
Хотя как закрепления информации давайте рассмотрим пример:<br>
<blockquote class=text3>
	ipset -N set_video_nets nethash <br>
	ipset -A set_video_nets 208.117.224.0/19 <br>
	ipset -A set_video_nets 83.229.247.0/24 <br>
	ipset -N set_video_ip iphash <br>
	ipset -A set_video_ip 94.100.179.115 <br>
	ipset -A set_video_ip 81.19.66.144 <br>
	ipset -A set_video_ip 81.19.66.145 <br>
	ipset -A set_video_ip 74.125.77.100 <br>
	ipset -A set_video_ip 74.125.77.113 <br>
	ipset -A set_video_ip 74.125.77.102 <br>
	ipset -A set_video_ip 74.125.77.139 <br>
	ipset -N set_videos setlist <br>
	ipset -A set_videos set_video_nets <br>
	ipset -A set_videos set_video_ip <br>
	cd /usr/local/iptconf/sets <br>
	ipset -S set_video_nets >./set_video_nets <br>
	ipset -S set_video_ip >./set_video_ip <br>
	ipset -S set_videos >./set_videos <br>
	cd .. <br>
	echo "set_video_nets" >>./ipsetlist <br>
	echo "set_video_ip" >>./ipsetlist <br>
	echo "set_videos" >>./ipsetlist <br>
</blockquote>	
&nbsp&nbsp&nbsp Это пример создания из консоли сет-листа, состоящего из двух сетов разного типа - один из них имеет тип iphash, а другой nethash. Соответственно, в лист set_video_nets можно вносить подсети, а в set_video_ip - конкретные адреса, в итоге set_videos представляет их как один сет.<br>
<br>
&nbsp&nbsp&nbsp <b><u>ВАЖНО:</u></b> Есть сет под названием <b>locals</b>. Он используется программой для определения локальных подсетей при генерации правил для iptables. НЕ УДАЛЯЙТЕ его! Иначе будут ошибки при генерации правил, если и сгенерируются, то вряд ли заработают. <br>
</p>
<noindex><a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./../index.html">Содержание</a></noindex><br>
<br>
<br>
<br>
<h3><a name="users" class=nolnk>4.8 Управление группами и клиентами</a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp Данные о группах и о клиентах лежат в каталоге из переменной $users_dir (по умолчанию /usr/local/iptconf/usr). <br>
<br>
В этом каталоге должны быть файлы с именами типа <font class=text1>_usr_groupname</font>. Собственно, здесь <font class=text1>groupname</font> это краткое название группы клиентов, а <font class=text1>_usr_</font> - маска, которая должна быть перед названием группы. Причем, в названии файла не должно быть ".bak". Именно такие файлы ищет и читает Fantomas, а потом пытается найти в них сведения о своих клиентах. <br>
<br>
По умолчанию каталог может быть вообще пуст, если при установке программы, установщик для Вас не проводил сканирование сети с помощью nmap. Если хотите, скрипт, работающий с nmap, называется sbnetscan и лежит в каталоге tools. Этот скрипт просканирует подсеть, которую Вы ему укажете, создаст файл _usr_default с политикой по умолчанию для всех клиентов - default. Если это для Вас подходит, можете подправить по своим потребностям политику default и запустить sbnetscan.<br>
<br>
Синтаксис файлов "_usr_*" следующий:
<br>
<blockquote class=text1>
	title "Подробное название группы клиентов" <br>
	_default_policy=&ltdefault_policy_name&gt <br>
	&ltclient_ip1&gt [ policy:&ltpolicies&gt ] [ cname:"client_name" ]<br>
	... <br>
	&ltclient_ipN&gt [ policy:&ltpolicies&gt ] <br>
</blockquote>
&nbsp&nbsp&nbsp Полагаю здесь с первыми двумя строками все понятно, поясню по остальным: каждая строка начинается ip-адресом клиента, после которого может быть аргумент "policy", который через двоеточие указывает на одну или несколько политик, назначенных клиенту. Аргумент "cname" служит для указания имени клиента, которое должно указываться в кавычках и без пробелов.<br>
<br>
&nbsp&nbsp&nbsp К примеру, если политика назначена одна, то она указывается просто через двоеточие: <font class=text1>192.168.0.11 policy:default_web</font> . <br>
А если политик несколько, то они после двоеточия заключаются в скобки и перечисляются через запятую: <br>
<div style="padding-left:60px;"><font class=text1>192.168.0.11 policy:(default_web,out_smtp_allow,out_rdp_allow)</font> .</div> 
&nbsp&nbsp&nbsp Если после адреса клиента аргумент "policy" отсутствует, то подразумевается что клиент использует политику по умолчанию для группы, которая задана выше в аргументе _default_policy. <br>
<br>
<br>
</td></tr><tr><td class=td3><li class=subpoint> Обработка клиентов в консоли</li></td></tr><tr><td class=td3>
<br>&nbsp&nbsp&nbsp Начиная с версии 0.1.5 в Fantomas был расширен функционал консольной утилиты программы iptconf.php (см.<a href="#iptconf">раздел 4.9.</a>) - появилась возможность просматривать состояние счетчиков клиента и в реальном времени добавлять и удалять клиентам политики (как и в веб-интерфейсе, при добавлении политики по ней генерируются правила, и при удалении правила удаляются). <br>
&nbsp&nbsp&nbsp Таким образом, можно просто вписать отдельной строчкой адрес клиента в файл группы, а затем воспользоваться утилитой iptconf.php для назначения политик этому клиенту. Подробней о работе утилиты см. в разделе 4.9..<br>
<br>
&nbsp&nbsp&nbsp В более ранних версиях Fantomas работа с клиентами заключается в прямом редактировании файлов групп, при этом политики для клиента также необходимо вписывать вручную. Затем, для того чтобы изменения вступили в силу нужно запустить процедуру пересоздания конфигурации (RELOAD). <br>
<br>
<br>
</td></tr><tr><td class=td3><li class=subpoint> Работа с клиентами в веб-интерфейсе</li></td></tr><tr><td class=td3>
<br>&nbsp&nbsp В веб-интерфейсе работа с клиентами происходит в реальном времени: при каждом изменении настроек клиента (добавлении или удалении политики) соответственно создаются или удаляются правила по обрабатываемой политике для текущего клиента: при добавлении клиенту политики генерируются соответствующие правила, при удалении политики с клиента - правила удаляются. Так выглядит страница клиента: <br>
<img src="./client_form.gif" title="страница клиента">
<br>
&nbsp&nbsp Для того, чтобы применить для клиента новую политику нужно просто выбрать ее идентификатор из разворачивающегося списка и нажать "Ok". <br>
<br>
&nbsp&nbsp Создание нового клиента происходит через веб-форму аналогичного типа. Вообще, при создании веб-интерфейса изначально упор делался на удобство для администратора, простоту и юзабилити, поэтому многое в Fantomas, надеюсь, Вам будет интуитивно понятно. <br>
<br>
&nbsp&nbsp Из тонкостей хочу еще предупредить: при операциях с клиентом для упрощения работы и повышения юзабилити, Fantomas не спрашивает подтверждение, а сразу выполняет указанное действие. Поэтому будьте внимательны, кликая мышкой по иконкам. Впрочем, на всех иконках есть всплывающие подсказки... <br>
<br>
</p>
<noindex><a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./../index.html">Содержание</a></noindex><br>
<br>
<br>
<br>
<h3><a name="modes" class=nolnk>4.9 Глобальные процедуры: конфигурирование системы и обработка счетчиков </a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp Fantomas имеет процедуры, которые выполняются не "на лету" по кому то отдельно, а глобально для всей конфигурации в целом.<br>
&nbsp&nbsp&nbsp Например, Эти процедуры, прочитав настройки, генерируют конфигурацию Iptables при загрузке системы (<font class=text1>service iptcldr start</font>), аналогично при завершении работы эти же процедуры выгружают счетчики для того, чтобы при загрузке их прочитать. <br>
&nbsp&nbsp&nbsp Также эти функции можно использовать и произвольно по необходимости, например, для бекапа счетчиков или для устранения каких либо ошибок в конфигурации путем ее полной перегенерации. <br>
<br>
&nbsp&nbsp&nbsp Итак, глобальные процедуры: <br>
<br>
<li> <b>SaveCounts</b> (в консоли) он же <b>Export counters</b> (веб-интерфейс) - в этом режиме программа выгружает счетчики трафика по клиентам из iptables/kernel в файл counters в каталоге iptconf (по умолчанию /usr/local/iptconf). 
&nbsp&nbsp&nbsp Экспорт счетчиков также выполняется при остановке сервиса iptcldr, а при его запуске запускается режим RELOAD (генерирование конфигурации), который при генерации правил, из файла counters подставляет счетчики в формируемые правила. <br>
&nbsp&nbsp&nbsp Также файл counters может использоваться и просто как бэкап показаний счетчиков - при каждом экспорте старый файл counters не затирается, а переименовывается и перемещается в каталог из переменной $backup_dir. К примеру, если вдруг каким то образом показания счетчиков сбились, можно взять самый актуальный файл счетчиков, подсунуть его на место counters и запустить RELOAD с опцией NoKeepCounts (об этом дальше).<br>
<br>
<li> <b>RELOAD</b> - режим, в котором происходит перегенерирование конфигурации iptables. Сначала вызывается Export_counters, счетчики сохраняются в файле counters, затем выполняется очистка iptables, перезагружаются листы ipset, отрабатывает inits, и дальше заново формируется конфигурация правил на основе данных о клиентах, о политиках и на основе сведений о счетчиках из файла counters.<br>
&nbsp&nbsp&nbsp Режим имеет опцию <b>NoKeepCounts</b> - если она указана, то экспорт счетчиков не производится и при формировании правил сведения о счетчиках берутся из файла counters, который был записан при предыдущем экспорте (или который Вы заранее на его место подсунули).<br>
<br>
<li> <b>NewPeriod</b> (в консоли) он же <b>Объявить Амнистию</b> (веб-интерфейс) - в этом режиме производится экспорт счетчиков, бэкап файла счетчиков, очищаются показания счетчиков в правилах всех клиентов по всем их политикам, затем текущая дата записывается как дата начала нового периода.<br>
</p>
<br>
&nbsp&nbsp&nbsp Запускать процедуры возможно как из веб-интерфейса так и в консольном режиме. <br>
&nbsp&nbsp&nbsp В веб-интерфейсе панель глобальных процедур расположена на странице состояния Iptables, в меню "Система-&#62Iptables".<br>
<div class=text1 style="padding-left:80px;"> Скрин 2. панель глобальных процедур:<br><img src="./screen_iptables.gif" style="padding:20px; border:1px;border-style:solid;border-color:d2d6da;" title="Здесь же можно и просмотреть файлы счетчиков"> 
</div> 
<br>
&nbsp&nbsp&nbsp В консольном режиме запуск процедур выполняется через параметры скрипта <font class=text1>iptconf.php</font> (см.ниже). <br>
<br>
<noindex><a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./../index.html">Содержание</a></noindex><br>
<br>
<br>
<br>
<h3><a name="iptconf" class=nolnk>4.10 Консольная утилита iptconf.php</a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp Этот скрипт предназначен для доступа к базовому функционалу программы из коммандной строки.<br>
<br>
Синтаксис:<br><br>
<li> Вызов процедуры пересоздания конфигурации (RELOAD): <br>
<blockquote class=text1>
	iptconf.php [NoKeepCounts] Reload
</blockquote>
&nbsp&nbsp&nbsp Заметьте, NoKeepCounts указывается перед самим Reload - это правильное написание аргументов. Если написать наоборот, то Reload может случайно "забыть" что ему говорили "NoKeepCounts" и станет выгружать счетчики без учета этого параметра...<br>
<br>
<li> Вызов процедуры сохранения счетчиков в файл counters (SaveCounts): <br>
<blockquote class=text1>
	iptconf.php SaveCounts
</blockquote>
<li> Процедура открытия нового периода (NewPeriod/Объявить Амнистию): <br>
<blockquote class=text1>
	iptconf.php NewPeriod
</blockquote>
<li> Просмотр состояния политик и счетчиков трафика по политикам: <br>
<blockquote class=text1>
	iptconf.php group=&ltgroupname&gt client=&ltclient_ipaddr&gt [ListPolicies] [ShowTraffic] <br>
	<font style="FONT: italic 10pt Arial;">&nbsp&nbsp&nbsp&nbsp возможен и сокращенный синтаксис:</font> <br>
	iptconf.php --grp=&ltgroupname&gt --usr=&ltclient_ipaddr&gt [lspols] [shtraf] <br>
</blockquote>
<li> Работа со списком назначенных политик клиента: <br>
<blockquote class=text1>
	iptconf.php group=&ltgroupname&gt client=&ltclient_ipaddr&gt policy=&ltpolicyname&gt [AddPolicy|DeletePolicy] <br>
	<font style="FONT: italic 10pt Arial;">&nbsp&nbsp&nbsp&nbsp возможен и сокращенный синтаксис:</font> <br>
	iptconf.php --grp=&ltgroupname&gt --usr=&ltclient_ipaddr&gt --pp=&ltpolicyname&gt [addpol|delpol] <br>
</blockquote>
<br>
<br>

</p>
<noindex><a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./../index.html">Содержание</a></noindex><br>
<br>
<br>
<br>
<h3><a name="shaper" class=nolnk>4.11 Ограничение скорости трафика клиентов, скрипт ifbtool</a></h3>
<br>
<p>&nbsp&nbsp&nbsp Fantomas Iptconf использует шейпинг клиентского трафика на базе <a href="http://www.linuxfoundation.org/collaborate/workgroups/networking/ifb">IFB</a>. <br>
&nbsp&nbsp&nbsp Я не буду вдаваться в глубокие теоретические излияния, если кому то интересны глубинные механизмы работы этой технологии - Вы можете почерпнуть всю интересующую информацию с официальной страницы ifb и iproute2, а я опишу механизм работы вкратце: ядро ОС Linux по умолчанию поддерживает модуль ifb и это делает эту технологию наиболее доступной для использования при шейпинге трафика. Работает это следующим образом: поднимается виртуальный интерфейс (к примеру, ifb0), в котором создаются несколько очередей обработки пакетов, каждая из которых может иметь свою дисциплину (htb, sfq, tbf &etc). Каждая из этих дисциплин обработки очереди пакетов имеет свои свойства, параметры и особенности, подробно об этом Вы можете прочитать в документации <a href="http://www.opennet.ru/docs/RUS/LARTC/" target=_blank>LARTC</a>. Далее, на непосредственно существующем сетевом интерфейсе, к которому подключены клиенты, добавляются правила, переадресовывающие трафик указываемых Вами клиентов через созданный виртуальный интерфейс, при этом указывая какой именно из нескольких очередей пакетов этот трафик будет обработан. Соответственно, при поступлении трафика в очередь пакетов виртуального интерфейса, начинают отрабатывать алгоритмы дисциплины очереди и применяются указываемые Вами ограничения скорости трафика, а после этого пакеты возвращаются снова на физический сетевой интерфейс...  <br>
<br>
&nbsp&nbsp&nbsp Управлять этим механизмом Вы можете из веб-интерфейса в разделе "Клиенты и трафик->Шейпер трафика". На этой странице Вы можете включить/выключить шейпер и управлять набором правил шейпера.<br>
<br>
&nbsp&nbsp&nbsp По параметрам шейпера следует пояснить следующее:<br>
&nbsp&nbsp&nbsp <font class=text1>HW Интерфейс</font> - это физический сетевой интерфейс, обычно это внутренний интерфейс Вашего роутера, к которому подключена подсеть с Вашими клиентами. <br>
&nbsp&nbsp&nbsp <font class=text1>IFB Интерфейс</font> - виртуальный ifb-интерфейс, через который будет осуществляться пересылка трафика, оба этих параметра настраиваются в веб-интерфейсе в разделе "Настройки->Параметры->Система". <br>
<br>
&nbsp&nbsp&nbsp И еще кое что: когда Вы задаете скорость трафика для клиентов значения для входящей и исходящей скорости указываются слитно с единицами измерения - kbit, mbit, kbps, mbps. <br>
&nbsp&nbsp&nbsp Если указаны только цифры, то по-умолчанию подразумеваются килобиты(kbit). Пример: <font class=text1>512kbit</font> - 512 килобит, <font class=text1>256</font> - 256 килобит. <br>
<br>
&nbsp&nbsp&nbsp По умолчанию, когда поднимается интерфейс ifb, система создает интерфейс с именем ifb0, поэтому если Вы не планируете использовать более одного ifb-интерфейса, то менять этот параметр смысла нет. Но Вам нужно настроить название HW-интерфейса. <br>
&nbsp&nbsp&nbsp Я не зря упоминул о нескольких ifb-интерфейсах - в системе может быть и несколько таких интерфейсов и они могут содержать совершенно разные очереди пакетов для совершенно разных задач. Просто для "резания" скорости трафика в Fantomas вполне достаточно одного интерфейса.<br>
<br>
&nbsp&nbsp&nbsp Более широкие возможности работы для работы с ifb дает консольный скрипт <b>ifbtool</b>, который идет в дистрибутиве Fantomas и лежит в каталоге tools, в том же каталоге есть и файл с описанием скрипта, поэтому на этом я позволю себе подробно не останавливаться. <br>
&nbsp&nbsp&nbsp Для получения подробного описания синтаксиса ifbtool сделайте в консоли следующее:<br>
<blockquote class=text1>
	cd /usr/local/iptconf <br>
	tools/ifb help <br>
</blockquote>

<br>
</p>
<noindex><a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./../index.html">Содержание</a></noindex><br>






<br><br><br><br><br><br>
<br><br><br><hr><br><br>
<noindex><a href="..\index.html">Назад</a></noindex>
<br><br><br>


</td></tr></table>

</body>
</html>