<!doctype html public "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta http-equiv="Expires" content="<Mon, 01 Jan 1990 00:00:01 GMT">
<link rel="stylesheet" type="text/css" href="css1.css">
<title> Fantomas Iptconf :: Administration manual</title>
</head>
<body>
<br>

<table class=table1 style="95%"><tr><td class=td3 width="100%">
<div class=top1 style="padding-left:80px;">
<a name="top" class=nolnk>Fantomas Iptconf :: Краткое руководство :: Администрирование </a>
<br><font style="FONT: bolder 12pt Arial;">версия 0.2.1</font>
</div>
<hr>
<br>
<br>
<table class=table1 width="70%">
<tr><td class=top33t align=right>Политики:</td><td class=top33a><a href="config.html#policies">основы, синтаксис, управление</a>   </td></tr>
<tr><td> &nbsp </td><td class=top33asub>&#8594 <a href="config.html#policies">определение</a> </td></tr>
<tr><td> &nbsp </td><td class=top33asub>&#8594 <a href="config.html#polsintax">синтасис</a> </td></tr>
<tr><td class=top33t align=right>Ipset:</td><td class=top33a><a href="config.html#ipsetlist">управление списками сет-листов </a>  </td></tr>
<tr><td> &nbsp </td><td class=top33asub>&#8594 <a href="config.html#ipsetlist">определение</a> </td></tr>
<tr><td> &nbsp </td><td class=top33asub>&#8594 <a href="config.html#ipsetinteg">интеграция с Fantomas</a> </td></tr>
<tr><td class=top33t align=right>Группы и клиенты:</td><td class=top33a><a href="config.html#users">создание, редактирование, применение политик </a>   </td></tr>
<tr><td> &nbsp </td><td class=top33asub>&#8594 <a href="config.html#users">определение</a> </td></tr>
<tr><td> &nbsp </td><td class=top33asub>&#8594 <a href="config.html#usrsintax">синтасис</a> </td></tr>
<tr><td> &nbsp </td><td class=top33asub>&#8594 <a href="config.html#usrpolusage">применение политик, генерация правил</a> </td></tr>
<tr><td class=top33t align=right>Глобальные процедуры:</td><td class=top33a><a href="config.html#modes">конфигурирование системы и обработка счетчиков.</a>   </td></tr>
<tr><td class=top33t align=right>Iproute2:</td><td class=top33a><a href="config.html#iproute2">создание конфигурации.</a>   </td></tr>
</table>
<br>
<br>
<br>
<a href="./index.html" title="Перейти на главную" style="padding-left:150px;">Содержание</a>
<a href="./ipset.man.html" title="Перейти к IPSET man page" style="padding-left:70px;">Ipset man page</a>
<hr>
<br>
<br>
<br><br>
<br>
<br>
<h3><a name="policies" class=nolnk>:: Политики: основы, синтаксис, управление ::</a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp <b>Политика</b> - это краткое схематичное, синтаксически соответственно оформленное, описание видов сетевого трафика с указанием действий, которые должен применять маршрутизатор к этим видам трафика.<br>
<br>
&nbsp&nbsp&nbsp Политики хранятся в текстовом виде в файле "policies", они имеют свой несложный синтаксис (см.ниже), а также краткое название (идентификатор), которое используется во всех операциях с политикой: ее можно назначить клиенту или большому числу клиентов (или вообще всем). Можно политику назначить группе клиентов - тогда она будет использоваться как политика по-умолчанию для членов этой группы и при создании нового клиента будет применяться автоматически (потом Вы, конечно, можете ее отменить и назначить другую политику). <br>
<br>
&nbsp&nbsp&nbsp Каждому конкретному клиенту может быть назначено сколько угодно политик - их количество ограничено только аппаратными ресурсами сервера. Главное ограничение - виды трафика, описанные в каждой политике, крайне не желательно чтобы повторялись в других политиках, назначенных клиенту - иначе можно создать искусственный парадокс как для Iptables, который столкнется с противоречащими правилами для одного и того же трафика, так и для Fantomas, который при попытке определить принадлежность конкретного правила конкретной политике встанет перед серьезной проблемой выбора последней.<br>
<br>
<a name="polsintax" class=nolnk>&nbsp</a>&nbsp&nbsp Работать с политиками можно как в веб-интерфейсе, так и в консоли. Перед тем, как назначить политику какому либо клиенту или группе, ее нужно создать. <br>
&#8226 В веб-интерфейсе для этого служит раздел "Настройки->Политики", где расположены все необходимые инструменты для работы с политиками - информационная панель, две формы списка политик, форма поиска, сводная таблица маркеров используемых политиками, конструктор для создания новых политик, а также возможность создавать политики вручную.<br>
&#8226 При работе в консоли можно создавать политики путем непосредственного редактирования файла policies. <br>
<br>
<br>
&nbsp&nbsp&nbsp Синтаксис политик следующий:<br>

<blockquote class=text3>
	policy &#60policy_name&#62 { <br>
	title "произвольное описание политики" <br>
	[accept|reject] &#60proto&#62 &#60ports&#62 [dst|src] [[from|to] &#60address&#62] [quota &#60quota&#62] <br>
	[action] [snat|masquerade|dnat|input [&#60destination&#62]] <br>
	[in|out] [&#60provider&#62] <br>
	[manglemark &#60N&#62] <br>
	[count [nolog] ] <br>
	[[blacklist | allow_only] &#60list&#62] <br>
	} <br>
</blockquote>	
<br>
&nbsp&nbsp <font class=sub1>Примечание:</font> если Вы создаете политику из веб-интерфейса, то первую строку "<font class=text1>policy &#60policy_name&#62 {</font>" и последнюю строку "<font class=text1>}</font>" писать НЕ НУЖНО. Программа эти теги использует для идентификации политик и отделения их друг от друга, поэтому при созхранении политики начальные и конечные теги будут добавлены автоматически. <br>
&nbsp&nbsp <font class=sub1>Но</font> если Вы в консоли пишете политику, непосредственно редактируя файл policies, Вы должны обязательно использовать полный синтаксис.<br>
<br>
&nbsp&nbsp <font class=sub1>Да, и еще кое что:</font> обратите внимание что закрывающая скобка политики расположена на отдельной строке, а открывающая скобка - на одной строке с названием политики. Это "правильный" синтаксис, к которому программа приучалась с рождения, пожалуйста, используйте именно такое написание.<br>
<br>
<br>
&nbsp&nbsp&nbsp <b>По порядку о назначении тегов:</b><br>
&nbsp&nbsp&nbsp <li>строка 3: <font class=text1>accept | reject</font> - непосредственно описывает вид трафика и определяет главное действие над ним - accept или reject.<br>
&nbsp&nbsp&nbsp <font class=text1>&#60proto&#62</font> может быть tcp, udp, icmp или all. <br>
&nbsp&nbsp&nbsp <font class=text1>&#60ports&#62</font> может быть одним цифровым портом или несколькими портами через запятую в скобках: <font class=text1>(25,1080,3128)</font>. Порт или набор портов может иметь отрицание, которое будет означать отрицание порта или ВСЕГО набора портов, причем ставится отрицание внутри скобок: <font class=text1>(!25,1080,3128)</font>.<br>
&nbsp&nbsp&nbsp <font class=text1>dst | src </font> указание направленности трафика (--sport/--dport) : если src, то трафик идет с вышеуказанных портов, а если dst - на вышеуказанные порты. По умолчанию dst. К примеру, если у нас стоит задача описать ответный трафик почтового сервера (внутри сети есть почтовый сервер, к которому из интернет создан доступ через DNAT, а у нас стоит задача описать в политике трафик, который идет ОТ почтового сервера в интернет), то в этом случае это будет <font class=text1>src from 192.168.0.10</font>, где ip-адрес это <font class=text1>&#60address&#62</font> <br>
&nbsp&nbsp&nbsp <font class=text1>from | to</font> если указано, то при генерации правила, в качестве соответствующего аргумента (-s если from и -d если to) используется указанный в этой опции адрес. По умолчанию если iptables принимает в правиле сурс или дестинейшн пустым, то понимает его как all (разрешено все). К примеру, если Вам нужно разрешить трафик <font class=text1>tcp (25,110,80)</font> только на mail.ru, то так и пишем: <font class=text1>accept tcp (25,110,80) to www.mail.ru</font>. Имейте ввиду (!) что при генерации правила программа вместо www.mail.ru попытается подставить IP (доменное имя в правило iptables пихать как то некорректно), доменное имя от IP она пытается отличить по наличию трех точек, что может быть корректно не всегда. Поэтому желательно использовать все таки IP.     <br>
Еще пример: Вам нужно сделать проброс порта tcp:3389 внутрь сети, но только с двух ip-адресов. Тогда политика будет выглядеть так:<br>
<blockquote class=text3>
	title "Terminal Services DNAT for 2piplz" <br>
	accept tcp 3389 from 11.11.11.11 <br>
	accept tcp 3389 from 22.22.22.22 <br>
	in myprovider <br>
	count <br>
	action dnat 192.168.0.100 <br>
</blockquote>	
Согласитесь, несложный синтаксис? :)<br>
<br>
&nbsp&nbsp&nbsp <font class=text1>quota &#60quota&#62</font> Здесь указывается квота трафика, при достижении которого этот конкретный accept работать перестанет. Может указываться просто цифрами (понимается как байты), можно указывать обозначения мегабайт и гигабайт: 750mb, 2gb и т.п.. Т.е. если в политике несколько строк accept с разным трафиком, но quote указано только на одном accept, то при достижении лимита остальные два продолжат работать.  <br>

&nbsp&nbsp&nbsp <li>строка 4: <font class=text1>action</font> - Определяет действие, которое будет применяться ко всем строкам accept в политике. Действем может быть dnat, snat, masquerade или input. Из опций здесь можно указать только адрес destination у dnat. <br>
&nbsp&nbsp&nbsp Заметьте, у действия SNAT адрес source не указывается, в этом нет необходимости т.к. через какой внешний интерфейс уходит трафик определяет опция <font class=text1>out</font>.<br>
&nbsp&nbsp&nbsp Так жде происходит и при действии MASQUERADE. Собственно, описанные три действия имеют свои прямые корни из iptables и, надеюсь, будут понятны многим читателям. <br>                                        
&nbsp&nbsp&nbsp А вот о действии INPUT я поясню - это действие было специально добавлено для обработки трафика, идущего не транзитно через маршрутизатор, а локально к демону или процессу, работающему на сервере. В основном правила, генерируемые этим действием, выполняют accept для трафика своего демона и, если в политике указывается опция <font class=text1>count</font>, то "прогоняют" трафик через цепочки подсчета трафика. Таким образом это действие может использовать для подсчета и сбора статистики входящего и исходящего трафика для локальных приложений сервера.<br> 

&nbsp&nbsp&nbsp <li>строка 5: <font class=text1>in | out</font> - как уже было сказано, эта опция определяет через какого провайдера трафик будет уходить или наоборот, через какого он будет приходить (например для dnat).<br>

&nbsp&nbsp&nbsp <li>строка 6: <font class=text1>manglemark N</font> - Если указано, то все пакеты, соответствующие политике, будут маркироваться цифрой N в таблице mangle, а действия над ними будут осуществляться уже с приминением в правиле условия на совпадение маркировки "-m mark".  <br>

&nbsp&nbsp&nbsp <li>строка 7: <font class=text1>count [nolog]</font> - Если указано, то по всем строкам accept будет проводиться обработка счетчиков пакетов и байт в специальных таблицах COUNT_IN и COUNT_OUT. Опция <font class=text1>nolog</font> указывается в том случае, если Вы не хотите чтоб сведения о пакетах (размер, адреса источника и назначения, порт и т.п.) записывались в базу демона ulog. Имейте при этом ввиду что в этом случае Вы не сможете смотреть статистику о посещаемых сайтах по клиентам с этой политикой.<br>

&nbsp&nbsp&nbsp <li>строка 8: <font class=text1>[[blacklist | allow_only] &#60list&#62]</font> - управляет приминением листов ipset к данной политике (ко всем accept). Соответственно, если указано blacklist, то при адреса которые совпадают с указанным листом блокируются, а если указано allow_only, то блокируется все кроме указанного листа. Строк blacklist в политике может быть несколько, если необходимо применить к политике несколько листов, но опция allow_only должна быть только одна. <br>
<br>
<br>&nbsp&nbsp&nbsp Некоторые примеры политик Вы можете найти в дистрибутиве Fantomas в файле policies. <br>
</p>
<a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./index.html">Содержание</a><br>
<br>
<br>
<br>
<h3><a name="ipsetlist" class=nolnk>:: Ipset: управление списками сет-листов ipset ::</a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp Что такое ipset?<br>
&nbsp&nbsp&nbsp <b>Ipset</b> - это модуль, работающий на уровне ядра ОС Linux, который позволяет создавать в оперативной памяти компьютера длинные (нет, скорее очень длинные!!!) списки значений, и потом из правил Iptables выполнять проверки на совпадение условия со значениями в списке. Список значений в сет-листе может содержать тысячу или 5 тысяч записей - Ipset позволяет обрабатывать большие списки сет-листов практически БЕЗ задержек и существенной нагрузки на систему.<br>
<br>
&nbsp&nbsp&nbsp Список значений может содержать ip-адреса, программные порты, адреса подсетей, mac-адреса. Любой элемент любого сет-листа можно связать со списком другого сет-листа, тем самым заставляя при проверке по первому сет-листу, при совпадении связанного элемента, выполнять условия и второго сет-листа. Это называется <i><u>Биндинг</u></i>.<br>
<br>
&nbsp&nbsp&nbsp Подробную информацию по Ipset Вы можете получить или на <a href="http://ipset.netfilter.org/" target=_blank title="открыть ссылку в новом окне">сайте Ipset</a> или на странице <a href="./ipset.man.html" target=_blank title="открыть ссылку в новом окне">локальной копии Man Ipset</a>, взятой мной на сайте разработчиков. <br>
&nbsp&nbsp&nbsp Fantomas имеет раздел настройки, посвященный Ipset, имеющий все необходимые веб-инструменты (сет-панель), которые были созданы с целью визуализации, автоматизации и облегчения настройки сет-листов. Но для эффективной работы Вам потребуется понимание существующих типов сет-листов, механизмов отработки условий и связей. Поэтому, настоятельно рекомендуем ознакомиться с вышеуказанной "родной" докой по Ipset. <br>
<br>
<a name="ipsetinteg" class=nolnk>&nbsp</a>&nbsp&nbsp Fantomas хранит сет-листы в файлах, располагающихся по-умолчанию в каталоге <i><u>"/path-to/fantomas-iptconf/sets"</u></i> (настраивается в конфигурации программы). Изначально сет-листы создаются и настраиваются в оперативной памяти, а уже потом (например, после изменения) выгружаются в файл средствами самого Ipset (<font class=text1>ipset -S &#60setlist&#62 > /path/to-iptconf/sets/setlist</font>). Соответственно, при старте системы, когда загружается iptables и вся конфигурация, стартовый скрипт программы <font class=text1>iptcldr</font><font style="FONT: bold 14pt Arial;">*</font> читет используемые сет-листы в память предварительно (<font class=text1>ipset -R < /path/to-iptconf/sets/setlist</font>), и уже потом генерируется конфигурация iptables.<br>

<div class=text1 style="padding-left:80px;"> <font style="FONT: bold 14pt Arial; color:000000;">*</font> <font style="FONT: italic 11pt Arial;color:000000;">iptcldr -</font> скрипт на bash, является по сути доработанной версией init-скрипта iptables 1.4.3.2, предназначен для корректной обработки во время загрузки и выгрузки процедур выгрузки/чтения счетчиков клиентского трафика, выгрузки/чтения списка сет-листов из файла ipsetlist (см.чуть ниже), а также для генерации при загрузке конфигурации правил Iptables c применением последней версии выгруженных до перезагрузки счетчиков трафика. <br>
</div>
<br>
&nbsp&nbsp&nbsp Тот факт, что Fantomas напрямую работает с Ipset, на самом деле очень сильно развязывает руки администратору: получается, работать с сет-листами возможно не только через сет-панель Fantomas, но и просто из консоли, и вообще как угодно - при любом конфигурировании ipset, Вы настраиваете те же сет-листы, которые используются Fantomas. <br>
<br>
&nbsp&nbsp&nbsp Единственное что при этом важно учесть (<u><i>ВНИМАНИЕ!</u></i>) - инит-скрипт iptcldr при старте загружает сет-листы, имена которых будут найдены в файле <font class=text1>/path-to/iptconf/ipsetlist</font>, где они записаны по принципу "один сетлист - одна строка, без знаков препинания". В этот файл имена сет-листов попадают автоматически, если Вы создаете их через сет-панель, в противном случае, если хотите чтоб после перезагрузки сет-лист был загружен, Вам прийдется править файл ipsetlist собственноручно.<br>
</p>
&nbsp&nbsp&nbsp Вот пример использования двух сет-листов разного типа, объединенных третьим сет-листом (соответственно, при одном запросе, проверка насовпадение условия будет выполняться по обоим сет-листам последовательно):<br>
<blockquote class=text4>
	ipset -N set_video_nets nethash <br>
	ipset -A set_video_nets 208.117.224.0/19 <br>
	ipset -A set_video_nets 83.229.247.0/24 <br>
	ipset -N set_video_ip iphash <br>
	ipset -A set_video_ip 94.100.179.115 <br>
	ipset -A set_video_ip 81.19.66.144 <br>
	ipset -A set_video_ip 81.19.66.145 <br>
	ipset -A set_video_ip 74.125.77.100 <br>
	ipset -A set_video_ip 74.125.77.113 <br>
	ipset -A set_video_ip 74.125.77.102 <br>
	ipset -A set_video_ip 74.125.77.139 <br>
	ipset -N set_videos setlist <br>
	ipset -A set_videos set_video_nets <br>
	ipset -A set_videos set_video_ip <br>
	cd /usr/local/iptconf/sets <br>
	ipset -S set_video_nets >./set_video_nets <br>
	ipset -S set_video_ip >./set_video_ip <br>
	ipset -S set_videos >./set_videos <br>
	cd .. <br>
	echo "set_video_nets" >>./ipsetlist <br>
	echo "set_video_ip" >>./ipsetlist <br>
	echo "set_videos" >>./ipsetlist <br>
</blockquote>	
&nbsp&nbsp&nbsp <i><u>ВАЖНО:</u></i> Fantomas создает для работы сетлист под названием <b>locals</b>- он содержит список локальных подсетей и используется генератором правил Fantomas для проверки совпадений src/dst адресов одним правилом сразу по всему списку. <br>
&nbsp&nbsp&nbsp <u>НЕ УДАЛЯЙТЕ</u> и <u>НЕ Изменяйте самостоятельно</u> этот сетлист! <u>Иначе корректность работы программы НЕ гарантируется!</u> <br>
</p>
<a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./index.html">Содержание</a><br>
<br>
<br>
<br>
<h3><a name="users" class=nolnk>:: Группы и клиенты: создание, редактирование, применение политик ::</a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp Данные о группах и о клиентах лежат в каталоге из переменной $users_dir (по умолчанию /usr/local/iptconf/usr). <br>
<br>
&nbsp&nbsp&nbsp В этом каталоге должны быть файлы с именами типа <font class=text1>_usr_groupname</font>. Собственно, здесь: <br>
<div style="padding-left:80px;">
	<li> <font class=text1>groupname</font> - это краткое название группы клиентов.  <br>
	<li> <font class=text1>_usr_</font> - маска, которая обязательно должна быть в начале имени файла. <br>
	<li> Имена файлов чувствительны к регистру. <br> 
	<li> В названии файла не должно встречаться сочетание символов ".bak". <br>
</div>
<br>
&nbsp&nbsp&nbsp Именно такие файлы Fantomas будет считать файлами групп клиентов, в которых должны содержаться сведения о клиентах, состоящих в группах, соответствущих именам файлов. <br>
<br>
&nbsp&nbsp&nbsp По умолчанию каталог usr пуст. Но если при установке Fantomas обнаружил установленный сканер nmap, то скрипт-установщик, запросив подтверждение, должен был просканировать локальные подсети и составить список доступных хостов. В этом случае все найденные клиенты были размещены в группе "default" (<font class=text1>usr/_usr_default</font>). <br>
&nbsp&nbsp&nbsp Если понадобится - скрипт, работающий с nmap, Вы можете найти в каталоге tools, под именем sbnetscan. Cкрипт сканирует подсеть, которую Вы ему указываете, ищет новые адреса и пишет их по-умолчанию в файл _usr_default (Это настраивается в самом скрипте в самом его начале в переменной <font class=text1>tusr</font>). Политика по умолчанию проставляется та, что указана в теге <font class=text1>_default_policy</font>) в указанном файле группы клиентов, по умолчанию это политика "default". <br>
&nbsp&nbsp&nbsp То есть Вы можете создать нужную Вам политику, создать группу клиентов с указанием созданной политики как _default_policy, после этого прописываете название файла группы в скрипте и после этого запускайте сканирование. Найденные клиенты будут занесены в указанную группу с указанной политикой.<br>
<a name="usrsintax" class=nolnk>&nbsp</a><br>
&nbsp&nbsp&nbsp Синтаксис файлов "_usr_*" следующий:
<br>
<blockquote class=text1>
	title "Подробное название группы клиентов" <br>
	_default_policy=&#60default_policy_name&#62 <br>
	&#60client_ip1&#62 [ policy:&#60policies&#62 ] [ cname:"client_name" ]<br>
	... <br>
	&#60client_ipN&#62 [ policy:&#60policies&#62 ] [ cname:"client_name" ]<br>
</blockquote>
&nbsp&nbsp&nbsp Полагаю, с первыми двумя строками все понятно. Поясню по остальным: каждая строка начинается ip-адресом клиента, после которого может быть тег <font class=text1>"policy"</font>, который через двоеточие указывает на одну или несколько политик, назначенных клиенту. <br>
<u><i>Внимание!</i>:</u> Если в списке назначенных политик их несколько, то они перечисляются через запятую и берутся в скобки, например, так: <font class=text1>policy:(policy1,policy2,policy3)</font>. <br>
<br>
&nbsp&nbsp&nbsp Тег <font class=text1>"cname"</font> служит для указания имени клиента, которое должно указываться в кавычках и без пробелов. Пробелы в именах возможно вводить когда Вы присваиваете имя клиенту в веб-интерфейсе - там при сохранении пробелы автоматически подменяются на подчеркивания.<br>
<br>
&nbsp&nbsp&nbsp Если после адреса клиента в строке тег "policy" отсутствует, то подразумевается что клиент использует политику по умолчанию для группы (_default_policy). <br>
<blockquote>
<a name="usrpolusage" class=nolnk>&nbsp</a>&nbsp&nbsp <b> &#9830 Применение политик, генерация правил iptables </b> <br>
</blockquote>
&nbsp&nbsp&nbsp Разумеется, если Вы пропишете вручную в файле группы строку клиента вида:
 <div class=text1 style="padding-left:80px;">192.168.0.44 policy:some_nat cname:"Some_man_user"</div>
&nbsp&nbsp&nbsp ... то конфигурация Iptables при этом никак не изменится. Для того, чтобы Fantomas в этом случае сгенерировал нужные правила согласно списку политик клиента 192.168.0.44, нужно запустить в Fantomas процедуру <u><i>RELOAD</i></u><font style="FONT: bolder 14pt Arial;">*</font>.  <br>
&nbsp&nbsp&nbsp Это можно сделать из веб-интерфейса в разделе "Система->Iptables" или в консоли путем запуска:
 <div class=text1 style="padding-left:80px;">iptconf.php reload </div>
<br>
<div class=text1 style="padding-left:80px;"> <font style="FONT: bold 14pt Arial; color:000000;">*</font> <font style="FONT: italic 11pt Arial;color:000000;">RELOAD -</font> штатная процедура Fantomas, при запуске которой происходит выгрузка счетчиков клиентского трафика, полная очистка конфигурации Iptables и Ipset, и далее заново загружаются сетлисты по списку файла ipsetlist, после этого происходит чтение настроек политик ВСЕХ клиентов и генерация правил по каждому клиенту с применением показаний счетчиков трафика из последней доступной версии файла счетчиков (по умолчанию те счетчики, что выгружались при запуске процедуры). <br>
Подробно обо всех процедурах ниже.<br>
</div>
&nbsp&nbsp&nbsp Однако, это все пережитки ранних версий Fantomas... <br>
<br>
&nbsp&nbsp&nbsp В Fantomas есть возможность применять и удалять действие политик на конкретном клиенте <u><i>"на лету"</i></u>, без запуска RELOAD и полной перезагрузки конфигурации.<br>
&nbsp&nbsp&nbsp Для того, чтобы к клиенту применить новую политику (тем самым добавив этому клиенту разрешающие или запрещающие правила по этой политике), в веб-интерфейсе нужно в дереве меню развернуть список групп, открыть группу, найти клиента, открыть страницу клиента. И на этой странице в форме добавления политики выбрать в разворачивающемся списке нужную политику и нажать "Ok". <br>
&nbsp&nbsp&nbsp При этом правила согласно политик для выбранного клиента сгенерируются сразу при добавлении политики. <br>
&nbsp&nbsp&nbsp На той же странице клиента доступна кнопка удаления политики:
<br>
<div class=text1 style="padding-left:80px;"> Скрин 1. страница клиента:<br><img src="./screen_client_form.gif" style="padding:20px; border:1px;border-style:solid;border-color:d2d6da;" title="Развернуть список, выбрать политику и нажать на кнопку. Все."> 
</div> 
<br>
&nbsp&nbsp&nbsp Также можно применять и удалять политики "на лету" и в консольном режиме. Для этого используется скрипт <font class=text1>iptconf.php</font> со следующим синтаксисом: <br>
<br>
 <div class=text1 style="padding-left:80px;">
 iptconf.php group=&#60groupname&#62 client=&#60client_ipaddr&#62 policy=&#60policyname&#62 [AddPolicy|DeletePolicy] <br>
 <blockquote style="color:000000;padding-left:50px;">возможен и альтернативный синтаксис: </blockquote>
 iptconf.php --grp=&#60groupname&#62 --cli=&#60client_ipaddr&#62 --pp=&#60policyname&#62 [addpol|delpol] <br>
</div>
<br>
&nbsp&nbsp Ну и напоследок: <font style="text-decoration:underline;font-style:italic">(ВАЖНО!)</font> Имейте ввиду что нельзя изменять политику, которая применена к одному или нескольим клиентам. Причина: при редактировании политики изменяется ее текст, новый текст записывается вместо старого, но правила Iptables, созданные на базе старой политики <u><i>НЕ ПЕРЕГЕНЕРИРУЮТСЯ СРАЗУ</i></u> при этом. Для того, чтобы изменения политики вступили в силу нужно запустить процедуру RELOAD. <br>
&nbsp&nbsp В случае, если новые правила accept в измененной политике существенно отличаются от прежних, то будьте готовы к тому что Вы потеряете показания счетчиков по этой политике. Причина проста - программа не сможет идентифицировать какому из новых accept соответствуют экспортированные до этого счетчики. <br>
<br>

</p>
<a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./index.html">Содержание</a> <br>
<br>
<br>
<br>
<h3><a name="modes" class=nolnk>:: Глобальные процедуры: конфигурирование системы и обработка счетчиков ::</a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp Fantomas имеет процедуры, которые выполняются не "на лету" по кому то отдельно, а глобально для всей конфигурации в целом.<br>
&nbsp&nbsp&nbsp Например, Эти процедуры, прочитав настройки, генерируют конфигурацию Iptables при загрузке системы (<font class=text1>service iptcldr start</font>), аналогично при завершении работы эти же процедуры выгружают счетчики для того, чтобы при загрузке их прочитать. <br>
&nbsp&nbsp&nbsp Также эти функции можно использовать и произвольно по необходимости, например, для бекапа счетчиков или для устранения каких либо ошибок в конфигурации путем ее полной перегенерации. <br>
<br>
&nbsp&nbsp&nbsp Итак, глобальные процедуры: <br>
<li> <b>SaveCounts</b> (в консоли) он же <b>Export counters</b> (веб-интерфейс) - в этом режиме программа выгружает счетчики трафика по клиентам из iptables/kernel в файл counters в каталоге iptconf (по умолчанию /usr/local/iptconf). 
&nbsp&nbsp&nbsp Экспорт счетчиков также выполняется при остановке сервиса iptcldr, а при его запуске запускается режим RELOAD (генерирование конфигурации), который при генерации правил, из файла counters подставляет счетчики в формируемые правила. <br>
&nbsp&nbsp&nbsp Также файл counters может использоваться и просто как бэкап показаний счетчиков - при каждом экспорте старый файл counters не затирается, а переименовывается и перемещается в каталог из переменной $backup_dir. К примеру, если вдруг каким то образом показания счетчиков сбились, можно взять самый актуальный файл счетчиков, подсунуть его на место counters и запустить RELOAD с опцией NoKeepCounts (об этом дальше).<br>
<br>
<li> <b>RELOAD</b> - режим, в котором происходит перегенерирование конфигурации iptables. Сначала вызывается Export_counters, счетчики сохраняются в файле counters, затем выполняется очистка iptables, перезагружаются листы ipset, отрабатывает inits, и дальше заново формируется конфигурация правил на основе данных о клиентах, о политиках и на основе сведений о счетчиках из файла counters.<br>
&nbsp&nbsp&nbsp Режим имеет опцию <b>NoKeepCounts</b> - если она указана, то экспорт счетчиков не производится и при формировании правил сведения о счетчиках берутся из файла counters, который был записан при предыдущем экспорте (или который Вы заранее на его место подсунули).<br>
<br>
<li> <b>NewPeriod</b> (в консоли) он же <b>Объявить Амнистию</b> (веб-интерфейс) - в этом режиме производится экспорт счетчиков, бэкап файла счетчиков, очищаются показания счетчиков в правилах всех клиентов по всем их политикам, затем текущая дата записывается как дата начала нового периода.<br>
</p>
<br>
&nbsp&nbsp&nbsp Запускать процедуры возможно как из веб-интерфейса так и в консольном режиме. <br>
&nbsp&nbsp&nbsp В веб-интерфейсе панель глобальных процедур расположена на странице состояния Iptables, в меню "Система-&#62Iptables".<br>
<div class=text1 style="padding-left:80px;"> Скрин 2. панель глобальных процедур:<br><img src="./screen_iptables.gif" style="padding:20px; border:1px;border-style:solid;border-color:d2d6da;" title="Здесь же можно и просмотреть файлы счетчиков"> 
</div> 
<br>
&nbsp&nbsp&nbsp В консольном режиме запуск процедур выполняется через параметры скрипта <font class=text1>iptconf.php</font>: <br>
<blockquote class=text1>
	iptconf.php SaveCounts <br>
	iptconf.php [NoKeepCounts] Reload <br>
	iptconf.php NewPeriod <br>
</blockquote>
<br>
&nbsp&nbsp&nbsp Заметьте, NoKeepCounts указывается перед самим Reload - это правильное написание аргументов. Если написать наоборот, то Reload может случайно "забыть" что ему говорили "NoKeepCounts" и станет выгружать счетчики по новой... В общем то, да, это баг - нужно переделать цикл в котором обрабатываются параметры коммандной строки в скрипте iptconf.php, но руки пока не дошли - не очень то надо было, т.к. я обычно все делал через веб. Исправлю.<br>
<br>
<a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./index.html">Содержание</a><br>
<br>
<br>
<br>
<h3><a name="iproute2" class=nolnk>:: Iproute2: создание конфигурации ::</a></h3>
<br>
<br>
<p>&nbsp&nbsp&nbsp Fantomas имеет возможность при старте своего init-скрипта iptcldr загружать список маршрутов Iproute2. Эта опция включается в разделе "Система -> Iproute2", там доступно включение/выключение самой опции, также там можно указать сам файл конфига cо списком маршрутов, и еще там есть панель таблиц маршрутизации в которой можно добавлять/удалять таблицы и просматривать загруженные маршруты по таблицам.<br>
<br>
&nbsp&nbsp&nbsp Файл списка маршрутов называется iproute2-init и хранится в каталоге программы. Немного о самом файле: структура файла разбита на секции, каждая из которых должна принадлежать отдельной таблице маршрутизации и в этой секции должны располагаться правила этой таблицы, последняя же из секций должна содержать правила iproute2 (ip rule list). <br>
<br>
&nbsp&nbsp&nbsp Обычная секция таблицы маршрутизации выглядит так: <br>
<blockquote class=text1>
	### table &lttablename&gt zone <br>
	ip route add ... table &lttablename&gt <br>
	ip route add ... table &lttablename&gt <br>
	######### end zone <br>
</blockquote>
<br>
&nbsp&nbsp&nbsp Обратите внимание на количество знаков "#" и написание "table &gtname&lt zone" - писать нужно именно так! Это связано с тем что именно по этим строчкам программа распознает где начинается и где заканчивается секции таблиц. <br>
&nbsp&nbsp&nbsp Соответственно, сколько таблиц маршрутизации, столько и секций в файле должно быть. <br>
<br>
&nbsp&nbsp&nbsp Из веб-интерфейса файл не редактируется, т.к. имхо обычно такой файл вообще настраивается один раз и забывается, поэтому для редактирования файла iproute2-init пользуйтесь консолью.<br>
<br>
&nbsp&nbsp&nbsp В консоли есть специальная утилита для работы с таблицами маршрутизации, описанными в файле iproute2-init - tabloid. Это скрипт, располагающийся в подкаталоге tools, его синтаксис предельно прост:<br>
<blockquote class=text1>
	tabloid {up|down|reload} [target=&lttablename&gt] <br>
</blockquote>
<br>
<br>
</p>
<br>
<br>
<br>
<a href="config.html#top">Наверх</a> &nbsp&nbsp <a href="./index.html">Содержание</a><br>
<br>

<br><br><br><br><br><br>
<br><br><br><hr><br><br>
<br><br><br>


</td></tr></table>

</body>
</html>