<!doctype html public "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta http-equiv="Expires" content="<Mon, 01 Jan 1990 00:00:01 GMT">
<link rel="stylesheet" type="text/css" href="css1.css">
<title> Fantomas Iptconf :: Administration manual</title>
</head>
<body>
<br>

<table class=table1 style="95%"><tr><td class=td3 width="100%">
<div class=top1 style="padding-left:80px;">
<a name="top" class=nolnk>Fantomas Iptconf :: Краткое руководство :: Введение </a>
<br><font style="FONT: bolder 12pt Arial;">версия 0.2.1</font>
</div>
<hr>
<br>
<br>
<table class=table1 width="70%">
<tr><td class=top33t align=right>О программе:</td><td class=top33a><a href="intro.html#wtf">принцип работы</a>   </td></tr>
<tr><td class=top33t align=right>Первые шаги:</td><td class=top33a><a href="intro.html#whatsnow">с чего начать?</a>   </td></tr>
</table>
<br>
<br>
<br>
<a href="./index.html" title="Перейти на главную" style="padding-left:150px;">Содержание</a>
<a href="./ipset.man.html" title="Перейти к IPSET man page" style="padding-left:70px;">Ipset man page</a>
<hr>
<br>
<br>
<br><br>
<br>
<br>
<h3><a name="wtf" class=nolnk>:: О программе: принцип работы ::</a></h3>
<br>
<br>
<p>
&nbsp&nbsp&nbsp Основной принцип работы <b>Fantomas Iptconf</b> основан на использовании штатных возможностей пакета программ Netfilter framework (Iptables, Ipset, Ulogd) и ядра ОС Linux - штатно в Linux-based системе уже есть весь необходимый функционал для создания полноценного маршрутизатора со всеми опциями, требующимися для предоставления услуг передачи сетевого трафика. Другое дело что все эти вещи поддерживаются в виде модулей, включаемых в ядро Linux, однако с управляющим инструментарием здесь не так хорошо как хотелось бы... Рано или поздно любой сетевой специалист, работающий со шлюзами на базе Iptables, приходит к мысли о необходимости автоматизировать набирание всех этих бесконечных консольных команд, которые используются для конфигурирования доступа клиентов. <br>
&nbsp&nbsp&nbsp Собственно, Fantomas Iptconf, это программа, которая появилась после того как ее автор попал как раз в такую ситуацию. По сути, идея создания Fantomas это попытка создать некий Front-end для Netfilter/Linux, который сможет не только вести учет сетевого трафика клиентов, но и позволит собрать в одном месте все инструменты для обслуживания маршрутизатора. <br>
<br>
&nbsp&nbsp&nbsp Итак, как это работает? Да очень просто! Когда через ядро Linux проходит какой либо пакет, удовлетворяющий одному из существующих правил Iptables, то модули ядра принимают действие ACCEPT для этого пакета, разрешая модулям iptables принимать дальнейшие действия над этим пакетом согласно созданной цепочке правил. Так вот, при каждом таком отрабатывающем правиле iptables, ядро системы ведет учет количества пакетов и количества байт данных, отработавших по каждому правилу. Это происходит в любом линуксе, поддерживающем iptables (т.е. во всех), независимо от того установлена ли какая либо билинговая система или нет. Собственно, первоначальная идея и состоит в том чтобы создать набор правил, содержащих нужные нам критерии для подсчета трафика (например, src host, dst host, proto, ports), и все, при прохождении такого трафика ядро системы будет накручивать показания счетчиков на созданных нами правилах iptables. А когда нам будет нужно, мы можем значения этих счетчиков переписать и использовать по своему усмотрению... Собственно, Fantomas примерно так и считает трафик: в таблице mangle есть две цепочки - COUNT_IN и COUNT_OUT, в которых содержатся правила, "накручивающие" счетчики по критериям, которые Вы зададите для каждого из криентов. В этих же цепочках есть и правила, отправляющие информацию о посчитанных пакетах демону Ulogd, который пишет в базу MySQL статистику по всем полученным им пакетам.<br>
<br>
&nbsp&nbsp&nbsp Вот таким образом, имея под рукой только дистрибутив Linux, можно считать трафик, собирать и хранить статистику о нем. Однако настраивать и обслуживать такую конфигурацию вручную очень долго и геморройно, особенно если клиентов много. Поэтому Вам нужен Fantomas для того чтобы автоматизировать этот процесс. Для создания нужного набора правил, Fantomas использует специальные "наборы настроек", в которых содержится информация о критериях трафика и о действиях которые нужно предпринять по нему. Такие "наборы настроек" хранятся отдельным списком и называются <b>Политики</b>. Так вот, для того чтобы сгенерировать по клиенту какие то правила iptables, нужно взять нужную политику и добавить ее этому клиенту и Fantomas создаст правила по клиенту согласно описаний трафика в политике. И политик клиенту можно назначить не одну и не две - их может быть сколько угодно..    <br>
<br>
&nbsp&nbsp&nbsp К примеру, если Вы хотите дать клиенту доступ в интернет через NAT, то Вы должны создать политику, описывающую какие именно протоколы и порты (или оставить all) будут разрешены и в качестве действия указать SNAT или Masquerade. А после создания политики, Вы должны ее применить клиенту, и у него появится доступ. <u>Причем, обратите внимание,</u> для каждого клиента НЕ НУЖНО создавать отдельную политику - политика может быть одна, и Вы будете ее назначать разным клиентам, давая тем самым им однотипный доступ. <br>
<br>
<br>
</p>
<a href="intro.html#top">Наверх</a> &nbsp&nbsp <a href="./index.html">Содержание</a><br>
<br>
<br>
<br>
<h3><a name="whatsnow" class=nolnk>:: Первые шаги: с чего начать? ::</a></h3>
<br>
<br>
<p>
&nbsp&nbsp&nbsp Не буду оригинален - начинать следует с документации. Данное руководство очень краткое, поэтому если это необходимо, обратитесь на сайт программы и скачайте полную версию руководства. Необходимо чтобы у Вас в голове сложилась полная картина что за программа перед Вами, что она может и что Вы хотите от нее, и уже тогда можно будет переходить к настройке Fantomas. <br>
<br> 
&nbsp&nbsp&nbsp Первое что следует настроить это сетевые подключения и подсети. При установке инсталлятор задавал Вам вопросы на эту тему и в списках интерфейсов и подсетей уже должны быть забиты данные, проверьте их правильность, проверьте правильно ли расставлены признаки локальных интерфейсов, это очень важно т.к. именно отсюда будет собираться список локальных подсетей и использоваться в виде списка ipset при генерации правил. Также для подсетей обратите внимание на признак "NotAllForward", если он установлен то для подсети по умолчанию не будет создано правило разрешающее форвард пакетов для всей подсети.<br>
<br>
&nbsp&nbsp&nbsp Дальше Вам нужно создать политики, которые Вы будете использовать для своих клиентов. Подробно о политиках читайте в следующем разделе и в полной версии документации. Если планируете использовать списки ipset для разрешения или запрещения доступа по спискам, то создайте нужные Вам списки в оснастке "Сет-панель". Для создания политик используйте панель политик в разделе "Настройка". <br>
<br>
&nbsp&nbsp&nbsp Теперь нужно подготовить список клиентов. Если при установке инсталлятор просканировал сеть nmap'ом и нашел какие то хосты, то Вы их найдете в группе Default, в противном случае группа будет пуста. Создайте нужное Вам количество групп, каждой группе Вы можете назначить политику по-умолчанию, которая будет проставляться по умолчанию для добавляемых клиентов. Можете переместить найденных клиентов из группы Default, это можно сделать нажав кнопку напротив нужного клиента при просмотре группы Default. <br>
<br>
&nbsp&nbsp&nbsp В идеале было бы хорошо если б в каждой группе все клиенты использовали политику по-умолчанию своей группы, в этом случае Вам не нужно будет для них вручную добавлять политику. Для специфичных же клиентов пройдитесь по группам и добавьте им соответствующие политики. <br>
<br>
&nbsp&nbsp&nbsp Если планируете использовать загрузку конфига iproute2, то создайте таблицы маршрутизации и заполните конфигурацию в файле iproute2-init. <br> <br>
<br>
&nbsp&nbsp&nbsp Когда закончите раздавать политики, перейдите в "Система->Iptables" и нажмите кнопку "Перезагрузить конфигурацию (RELOAD)". <br>
<br>
&nbsp&nbsp&nbsp Ну и не будет лишним если Вы зайдете в раздел "Система -> Crond" и создадите правило вроде "*/10 * * * * cd /usr/local/iptconf; ./iptconf.php savecounts" - и тогда показания счетчиков будут каждые 10 минут сохраняться на диск в файле counters. <br>
<br>
</p>
<a href="intro.html#top">Наверх</a> &nbsp&nbsp <a href="./index.html">Содержание</a><br>
<br>
<br>
<br>


<br><br><br><br><br><br>
<br><br><br><hr><br><br>
<br><br><br>


</td></tr></table>

</body>
</html>